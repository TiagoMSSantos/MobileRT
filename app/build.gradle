println("Reading system properties.")
final def systemNDKVersion = System.getProperty('ndkVersion', '21.0.6113669')
final def systemCMakeVersion = System.getProperty('cmakeVersion', '3.6.0')
final def systemTestType = System.getProperty('testType', 'debug')

println("NDK version: " + systemNDKVersion)
println("CMake version: " + systemCMakeVersion)
println("Test type: " + systemTestType)

apply plugin: 'com.android.application'

allprojects {
    tasks.withType(JavaCompile) {
        println("Adding additional flags to the compiler.")

        options.compilerArgs \
            << '-Xlint:all' \
            << '-AprintErrorStack' << '-AprintAllQualifiers' \
            << '-verbose'
    }
}

android {
    setNdkVersion systemNDKVersion
    setTestBuildType systemTestType

    setCompileSdkVersion 29
    setBuildToolsVersion '29.0.3'

    signingConfigs {
        Puscas {
            setStoreFile file('MobileRT.jks')
            setStorePassword '123456'
            setKeyPassword '123456'
            setKeyAlias 'Puscas'
        }
    }

    defaultConfig {
        setMinSdkVersion 16
        setTargetSdkVersion 29
        setTestInstrumentationRunner 'androidx.test.runner.AndroidJUnitRunner'
        setTestInstrumentationRunnerArguments clearPackageData: 'true'
        setApplicationId 'puscas.mobilertapp'
        setVersionName '1.0'
        setVersionCode 1
        setMultiDexEnabled true
        setTestHandleProfiling false
        setTestFunctionalTest false
        ndk {
            abiFilters 'armeabi-v7a', 'arm64-v8a', 'x86', 'x86_64'
            setModuleName 'MobileRT'
        }
        externalNativeBuild {
            cmake {
            }
        }
    }
    externalNativeBuild {
        cmake {
            setPath 'CMakeLists.txt'
            setVersion systemCMakeVersion
        }
    }
    compileOptions {
        setDefaultJavaVersion JavaVersion.VERSION_1_8
        setTargetCompatibility JavaVersion.VERSION_1_8
        setSourceCompatibility JavaVersion.VERSION_1_8
    }
    buildTypes {
        debug {
            setDebuggable true
            setJniDebuggable true
            setTestCoverageEnabled true
            setVersionNameSuffix 'd'
            setRenderscriptDebuggable true
            setRenderscriptOptimLevel 0
            setMinifyEnabled false
            setSigningConfig signingConfigs.Puscas
            setShrinkResources false
            ndk {
            }
        }
        release {
            setDebuggable false
            setJniDebuggable false
            setTestCoverageEnabled false
            setVersionNameSuffix 'r'
            setRenderscriptDebuggable false
            setRenderscriptOptimLevel 3
            setMinifyEnabled false
            setSigningConfig signingConfigs.Puscas
            setShrinkResources false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
            ndk {
            }
        }
    }
    productFlavors {
    }
    packagingOptions {
        exclude 'META-INF/LICENSE'
        exclude 'META-INF/LICENSE.md'
        exclude 'META-INF/LICENSE.txt'
        exclude 'META-INF/LICENSE-notice.md'
        exclude 'META-INF/license.txt'
        exclude 'META-INF/licenses/ASM'

        exclude 'META-INF/DEPENDENCIES'
        exclude 'META-INF/DEPENDENCIES.txt'
        exclude 'META-INF/dependencies.txt'

        exclude 'META-INF/NOTICE'
        exclude 'META-INF/NOTICE.txt'
        exclude 'META-INF/notice.txt'

        exclude 'META-INF/LGPL2.1'

        exclude '**/module-info.class'
    }
    testOptions {
        unitTests {
            includeAndroidResources = true
            returnDefaultValues = true
        }
        setAnimationsDisabled true
    }
    dexOptions {
        setJavaMaxHeapSize '1mb'
    }
    lintOptions {
        setAbortOnError true
        setCheckAllWarnings true
        setExplainIssues true
        setNoLines true
        setShowAll true
        setWarningsAsErrors true
        setCheckDependencies true
        setAbsolutePaths false
        setCheckGeneratedSources true
        setCheckReleaseBuilds true
        setCheckTestSources true
        setHtmlReport true
        setXmlReport false
        setTextReport false
        setIgnoreTestSources false
        setIgnoreWarnings false
        setQuiet false
    }
}

configurations {
    debug
    release
}

dependencies {
    println("Adding dependencies for MobileRT.")

    implementation 'androidx.appcompat:appcompat:1.1.0'
    implementation 'androidx.multidex:multidex:2.0.1'
    implementation 'com.google.guava:guava:29.0-jre'
    implementation 'net.sourceforge.streamsupport:streamsupport:1.7.2'
    implementation 'org.jetbrains:annotations:19.0.0'
    implementation 'org.apache.commons:commons-lang3:3.10'
    implementation 'org.apache.commons:commons-text:1.8'



    println("Adding dependencies for the instrumentation tests.")

    androidTestImplementation 'androidx.test:runner:1.2.0'
    androidTestImplementation 'junit:junit:4.13'

    androidTestImplementation 'org.junit.jupiter:junit-jupiter-api:5.6.2'
    androidTestImplementation 'org.assertj:assertj-core:3.15.0'
    androidTestImplementation 'org.mockito:mockito-android:3.3.3'
    androidTestImplementation 'org.mockito:mockito-core:3.3.3'
    androidTestImplementation 'com.google.truth:truth:1.0.1'

    androidTestImplementation 'androidx.test:core:1.2.0'

    androidTestImplementation 'androidx.test.espresso:espresso-accessibility:3.2.0'
    androidTestImplementation 'androidx.test.espresso:espresso-contrib:3.2.0'
    androidTestImplementation 'androidx.test.espresso:espresso-core:3.2.0'
    androidTestImplementation 'androidx.test.espresso:espresso-idling-resource:3.2.0'
    androidTestImplementation 'androidx.test.espresso:espresso-intents:3.2.0'
    androidTestImplementation 'androidx.test.espresso:espresso-web:3.2.0'
    androidTestImplementation 'androidx.test.espresso.idling:idling-concurrent:3.2.0'
    androidTestImplementation 'androidx.test:rules:1.2.0'



    println("Adding dependencies for the unit tests.")

    testImplementation 'junit:junit:4.13'
    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.6.2'
    testImplementation 'org.assertj:assertj-core:3.15.0'
    testImplementation 'org.khronos:opengl-api:gl1.1-android-2.1_r1'
}
