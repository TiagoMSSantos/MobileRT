name: Sync GitHub Page

on:
  workflow_dispatch:
  push:
    branches:
    - master
    paths-ignore:
    - '*'
    - '.github/**'
    - '**/renovate.json'
    - '!.github/workflows/github-pages.yml'
    - '!docs/**'

defaults:
  run:
    shell: bash
    working-directory: .

concurrency:
  group: ${{ github.workflow }} ${{ github.ref }}
  cancel-in-progress: true

jobs:
  github-pages:
    runs-on: ubuntu-20.04
    timeout-minutes: 3
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      REPOSITORY_TOKEN: ${{ secrets.REPOSITORY_TOKEN }}
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Install missing dependencies
      if: success() && false
      working-directory: .
      run: |
        set -euo pipefail;
        sudo apt update;
        sudo apt install -y ruby-dev;
        sudo gem install bundler:1.16.1;
        sudo gem update bundler --conservative;

    - name: Trigger GitHub pages rebuild
      if: success() && github.event_name == 'workflow_dispatch'
      working-directory: .
      run: |
        curl --fail --request POST \
          --url https://api.github.com/repos/${{ github.repository }}/pages/builds \
          --header "Authorization: Bearer ${USER_TOKEN}";
      env:
        # You must create a personal token with repo access as GitHub does
        # not yet support server-to-server page builds.
        USER_TOKEN: ${{ env.REPOSITORY_TOKEN }}

    - name: Doxygen build
      uses: mattnotmitt/doxygen-action@1.9.4
      if: success()
      with:
        doxyfile-path: ".codedocs" # Path to Doxyfile (default is ./Doxyfile)
        working-directory: "." # Working directory (default is .)
        enable-latex: false # Flag to enable make-ing of the LaTeX part of the doxygen output (default is false)

    - name: Doxygen deploy
      uses: peaceiris/actions-gh-pages@v3
      # Disabled since we use code docs for now: https://codedocs.xyz/TiagoMSSantos/MobileRT/
      if: success() && false
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/doxygen_html
        publish_branch: gh-pages  # Branch name to use as GitHub Pages branch (default is gh-pages)

    - name: Sync README with docker hub
      if: success()
      uses: ms-jpq/sync-dockerhub-readme@v1
      with:
        username: ${{ env.DOCKERHUB_USERNAME }}
        password: ${{ env.DOCKERHUB_PASSWORD }}
        repository: ptpuscas/mobile_rt
        readme: "docs/README.md"
