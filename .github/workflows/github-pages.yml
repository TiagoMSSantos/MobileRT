name: Deploy Jekyll GitHub Page

on:
  push:
    branches:
    - master
    paths-ignore:
    - '.github/**'
    - '!.github/workflows/github-pages.yml'

jobs:
  github-pages:
    runs-on: ubuntu-18.04
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      REPOSITORY_TOKEN: ${{ secrets.REPOSITORY_TOKEN }}
    steps:
    - name: Checkout
      uses: actions/checkout@v2.3.4

    - name: Install missing dependencies
      if: success()
      working-directory: .
      run: |
        sudo apt update;
        sudo apt install -y ruby-dev;
        sudo gem install bundler:1.16.1;
        sudo gem update bundler --conservative;

    - name: Trigger GitHub pages rebuild
      if: success()
      working-directory: .
      run: |
        curl --fail --request POST \
          --url https://api.github.com/repos/${{ github.repository }}/pages/builds \
          --header "Authorization: Bearer ${USER_TOKEN}"
      env:
        # You must create a personal token with repo access as GitHub does
        # not yet support server-to-server page builds.
        USER_TOKEN: ${{ env.REPOSITORY_TOKEN }}

    - name: Sync README with docker hub
      if: success()
      uses: ms-jpq/sync-dockerhub-readme@v1
      with:
        username: ${{ env.DOCKERHUB_USERNAME }}
        password: ${{ env.DOCKERHUB_PASSWORD }}
        repository: ptpuscas/mobile_rt
        readme: "docs/README.md"
