name: Release

on:
  push:
    tags:
      - "v[0-9]*.[0-9]*.[0-9]*"
permissions: {}

defaults:
  run:
    shell: sh
    working-directory: .

concurrency:
  group: ${{ github.workflow }} ${{ github.ref }}
  cancel-in-progress: true

# Default environment variables.
env:
  GITHUB_STEP_TIMEOUT_SMALL: 4
  GITHUB_STEP_TIMEOUT_MEDIUM: 10
  GITHUB_STEP_TIMEOUT_LONG: 20

jobs:
  Matrix:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    name: Set Matrix
    runs-on: ubuntu-latest
    timeout-minutes: 2

    outputs:
      android_matrix: ${{ steps.set-matrix.outputs.android_matrix }}
      release_api: ${{ steps.set-matrix.outputs.release_api }}
      native_matrix: ${{ steps.set-matrix.outputs.native_matrix }}

    steps:
      - name: Checkout
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        uses: actions/checkout@v6
        with:
          # Check available parameters in: https://github.com/actions/checkout/blob/main/action.yml
          lfs: true

      - name: Set Matrix
        id: set-matrix
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        shell: bash
        run: |
          # Android usage: https://apilevels.com
          ANDROID_MATRIX=$(jq -c '{ include:(.include | map(select(has("android_api"))))}' .github/workflows/release.json);
          echo "ANDROID_MATRIX: ${ANDROID_MATRIX}";
          echo "android_matrix=${ANDROID_MATRIX}" >> ${GITHUB_OUTPUT};
          RELEASE_API=$(jq -c '.include | map(select(has("android_api"))) | map(.android_api |= tonumber | .android_api_device |= tonumber) | sort_by(.android_api, .android_api_device) | .[0] | .android_api = (.android_api|tostring) | .android_api_device = (.android_api_device|tostring)' .github/workflows/release.json);
          RELEASE_API="$(echo {\"include\":[${RELEASE_API}])}";
          echo "RELEASE_API: ${RELEASE_API}";
          echo "release_api=${RELEASE_API}" >> ${GITHUB_OUTPUT};
          NATIVE_MATRIX=$(jq -c '{ include:(.include | map(select(has("android_api") | not)))}' .github/workflows/release.json);
          echo "NATIVE_MATRIX: ${NATIVE_MATRIX}";
          echo "native_matrix=${NATIVE_MATRIX}" >> ${GITHUB_OUTPUT};

  Android:
    needs: [Matrix]
    name: Android ${{ matrix.android_api }} ${{ matrix.type }} (${{ matrix.host_os }})
    strategy:
      fail-fast: true
      matrix: ${{ fromJSON(needs.Matrix.outputs.android_matrix) }}
    uses: ./.github/workflows/reusable-android.yml

    # Sets permissions of the GITHUB_TOKEN to allow delete cache and publish test results
    permissions:
      actions: write
      checks: write
      pull-requests: write # only required if `comment: true` was enabled

    with:
      host_os: ${{ matrix.host_os }}
      android_api: ${{ matrix.android_api }}
      android_api_device: ${{ matrix.android_api_device }}
      type: ${{ matrix.type }}
    # If you might want to use a secret in the build or test job then you would need to pass secrets, inherit disables secret isolation
    secrets: inherit


  Native:
    needs: [Matrix]
    name: Native ${{ matrix.type }} ${{ matrix.compiler }} (${{ matrix.host_os }})
    strategy:
      fail-fast: true
      matrix: ${{ fromJSON(needs.Matrix.outputs.native_matrix) }}
    uses: ./.github/workflows/reusable-native.yml

    # Sets permissions of the GITHUB_TOKEN to allow delete cache
    permissions:
      actions: write

    with:
      host_os: ${{ matrix.host_os }}
      type: ${{ matrix.type }}
      compiler: ${{ matrix.compiler }}
      qt_version: ${{ matrix.qt_version }}
      qt_arch: ${{ matrix.qt_arch }}
    # If you might want to use a secret in the build or test job then you would need to pass secrets, inherit disables secret isolation
    secrets: inherit

  ReleaseNotes:
    name: Generate Release Notes
    runs-on: ubuntu-latest
    timeout-minutes: 360

    strategy:
      fail-fast: true

    permissions:
      models: read

    outputs:
      release_notes: ${{ steps.release_notes.outputs.release_notes }}

    steps:
    - name: Checkout
      timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
      if: success()
      uses: actions/checkout@v6
      with:
        # Check available parameters in: https://github.com/actions/checkout/blob/main/action.yml
        fetch-depth: 0
        fetch-tags: true
        lfs: false

    - name: Generate Release Notes with AI Model
      id: release_notes
      timeout-minutes: 360
      shell: bash
      run: |
        # Configurations
        SLEEP_SECONDS=57; # To avoid HTTP 429 "Too Many Requests" - 56sec fails, but 60sec seems to work fine
        MAX_PAYLOAD_BYTES=32120; # To avoid HTTP 413 "Content Too Large" - 32KB is max payload size, 32130 bytes fails, but 32075 bytes seems to work fine

        jq . .github/workflows/release-notes-payload.json  > /dev/null; # validate JSON
        jq . .github/workflows/release-notes-merge.json  > /dev/null; # validate JSON

        ALL_TAGS=$(git for-each-ref --sort=-creatordate --format '%(refname:short)' refs/tags);
        echo "All tags: ${ALL_TAGS}";

        PREVIOUS_TAG=$(echo "${ALL_TAGS}" | sed -n '2p');
        echo "Previous tag: ${PREVIOUS_TAG}";

        git log "${PREVIOUS_TAG}.." --pretty=format:"%H" > shas.log;

        OFFSET=0;
        BATCH_INDEX=1;
        touch release_notes.log;
        echo "Sleeping between batches to avoid HTTP 429 Too Many Requests. SLEEP_SECONDS: ${SLEEP_SECONDS}.";
        while true; do
          mapfile -t ALL_SHAS < shas.log;
          TOTAL=${#ALL_SHAS[@]};

          [[ $OFFSET -ge $TOTAL ]] && {
            echo "Stopping since no more commits to process.";
            break
          }

          SHAS=();
          LAST_GOOD_SIZE=0;

          for ((i=OFFSET; i<TOTAL; i++)); do
            SHAS+=("${ALL_SHAS[$i]}")

            git show --stat=180 --pretty=format:"%s" "${SHAS[@]}" > commits.raw;

            jq \
              --rawfile agents AGENTS.md \
              --rawfile commits commits.raw \
              '
              def inject(name; value):
                gsub(name; (value | @json));

              walk(
                if type == "string" then
                  .
                  | inject("__AGENTS__"; $agents)
                  | inject("__COMMITS__"; $commits)
                else
                  .
                end
              )
              ' \
              < .github/workflows/release-notes-payload.json \
              > payload.json;
            jq . payload.json > /dev/null; # validate JSON
            SIZE=$(wc -c < payload.json);

            if (( SIZE > MAX_PAYLOAD_BYTES )); then
              unset 'SHAS[-1]';

              if (( ${#SHAS[@]} == 0 )); then
                echo "Single commit too large for payload limit."
                echo "Offending commit: ${ALL_SHAS[$i]}"
                exit 1
              fi

              git show --stat=180 --pretty=format:"%s" "${SHAS[@]}" > commits.raw;
              jq \
                --rawfile agents AGENTS.md \
                --rawfile commits commits.raw \
                '
                def inject(name; value):
                  gsub(name; (value | @json));

                walk(
                  if type == "string" then
                    .
                    | inject("__AGENTS__"; $agents)
                    | inject("__COMMITS__"; $commits)
                  else
                    .
                  end
                )
                ' \
                < .github/workflows/release-notes-payload.json \
                > payload.json;
              SIZE=$(wc -c < payload.json);
              break
            fi

            LAST_GOOD_SIZE=$SIZE
          done

          echo "Processing batch ${BATCH_INDEX} with ${#SHAS[@]} commits (offset ${OFFSET} - $(wc -c release_notes.log) - payload size: ${SIZE} bytes) [$(wc -l commits.raw)]: $(cat commits.raw | head -1)";
          sleep ${SLEEP_SECONDS};

          RESPONSE=$(
            curl --fail-with-body -s -S \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -d @payload.json \
              "https://models.inference.ai.azure.com/openai/deployments/gpt-4o-mini/chat/completions"
          )

          RELEASE_NOTES=$(echo "${RESPONSE}" | jq -r '.choices[0].message.content')
          echo "${RELEASE_NOTES}" >> release_notes.log

          awk '$0 ~ /^#/ || !seen[$0]++' release_notes.log > tmp && mv tmp release_notes.log; # Remove duplicate lines

          OFFSET=$((OFFSET + ${#SHAS[@]}))
          BATCH_INDEX=$((BATCH_INDEX + 1))
        done

        cat release_notes.log;
        wc -c release_notes.log;
        ls -lahp release_notes.log;

        echo 'Merging all release notes';
        TOTAL_LINES=$(wc -l < release_notes.log);
        MIDPOINT=$((TOTAL_LINES / 2));
        CUT_LINE=$(awk -v mid="$MIDPOINT" 'NR >= mid && /^## / {print NR; exit}' release_notes.log);
        # Fallback if no section header exists after midpoint
        if [[ -z "$CUT_LINE" ]]; then
          CUT_LINE=$((MIDPOINT + 1));
        fi
        head -n $((CUT_LINE-1)) release_notes.log > release_notes_part1.log;
        tail -n +$CUT_LINE release_notes.log > release_notes_part2.log;
        for ((part=1; part<=2; part++)); do
          jq \
            --rawfile agents AGENTS.md \
            --rawfile release_notes release_notes_part${part}.log \
            '
            def inject(name; value):
              gsub(name; (value | @json));

            walk(
              if type == "string" then
                .
                | inject("__AGENTS__"; $agents)
                | inject("__RELEASE_NOTES__"; $release_notes)
              else
                .
              end
            )
            ' \
            < .github/workflows/release-notes-merge.json \
            > payload.json;
          echo "JSON_PAYLOAD: $(cat payload.json)";
          jq . payload.json > /dev/null; # validate JSON

          SIZE=$(wc -c < payload.json);
          echo "Sleeping for ${SLEEP_SECONDS} seconds to avoid HTTP 429 Too Many Requests. Payload size: ${SIZE} bytes.";
          sleep ${SLEEP_SECONDS};

          RESPONSE=$(
            curl --fail-with-body -s -S \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -d @payload.json \
              "https://models.inference.ai.azure.com/openai/deployments/gpt-4o-mini/chat/completions"
          );
          RESPONSE=$(echo "${RESPONSE}" | jq -r '.choices[0].message.content');
          echo "Response: ${RESPONSE}";
          echo "${RESPONSE}" >> merged_release_notes.log;
        done

        cat merged_release_notes.log;
        wc -c merged_release_notes.log;
        ls -lahp merged_release_notes.log;

        jq \
          --rawfile agents AGENTS.md \
          --rawfile release_notes merged_release_notes.log \
          '
          def inject(name; value):
            gsub(name; (value | @json));

          walk(
            if type == "string" then
              .
              | inject("__AGENTS__"; $agents)
              | inject("__RELEASE_NOTES__"; $release_notes)
            else
              .
            end
          )
          ' \
          < .github/workflows/release-notes-merge.json \
          > payload.json;
        echo "JSON_PAYLOAD: $(cat payload.json)";
        jq . payload.json > /dev/null; # validate JSON

        SIZE=$(wc -c < payload.json);
        echo "Sleeping for ${SLEEP_SECONDS} seconds to avoid HTTP 429 Too Many Requests. Payload size: ${SIZE} bytes.";
        sleep ${SLEEP_SECONDS};

        RESPONSE=$(
          curl --fail-with-body -s -S \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -d @payload.json \
            "https://models.inference.ai.azure.com/openai/deployments/gpt-4o-mini/chat/completions"
        );
        RELEASE_NOTES=$(echo "${RESPONSE}" | jq -r '.choices[0].message.content');
        echo "Release notes: ${RELEASE_NOTES}";

        {
          echo "release_notes<<EOF";
          echo "${RELEASE_NOTES}";
          echo "EOF";
        } >> "$GITHUB_OUTPUT";


  Release:
    needs: [Matrix, ReleaseNotes, Native, Android]
    name: Release
    runs-on: ubuntu-latest
    timeout-minutes: 3

    permissions:
      contents: write

    strategy:
      fail-fast: true
      matrix: ${{ fromJSON(needs.Matrix.outputs.release_api) }}
    steps:
    - name: Checkout
      timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
      if: success()
      uses: actions/checkout@v6
      with:
        # Check available parameters in: https://github.com/actions/checkout/blob/main/action.yml
        fetch-depth: 1
        fetch-tags: false
        lfs: false

    # Download generated APK artifact
    # Taken from: https://github.com/marketplace/actions/download-workflow-artifact
    - name: Download Android packages artifact
      id: download-android-artifact
      timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
      if: success()
      uses: Wandalen/wretry.action@e68c23e6309f2871ca8ae4763e7629b9c258e1ea # v3
      with:
        # Check available parameters in: https://github.com/Wandalen/wretry.action/blob/master/action.yml
        action: dawidd6/action-download-artifact@0bd50d53a6d7fb5cb921e607957e9cc12b4ce392 # v12
        pre_retry_command: 'echo "Retrying Download Android packages artifact step..."'
        attempt_limit: 3
        attempt_delay: 30000
        with: |
          # Check available parameters in: https://github.com/dawidd6/action-download-artifact/blob/master/action.yml
          # Optional, GitHub token, a Personal Access Token with `public_repo` scope if needed
          # Required, if the artifact is from a different repo
          # Required, if the repo is private a Personal Access Token with `repo` scope is needed
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # Optional, workflow file name or ID
          # If not specified, will be inferred from run_id (if run_id is specified), or will be the current workflow
          workflow: release.yml
          # Optional, the status or conclusion of a completed workflow to search for
          # Can be one of a workflow conclusion:
          #   "failure", "success", "neutral", "cancelled", "skipped", "timed_out", "action_required"
          # Or a workflow status:
          #   "completed", "in_progress", "queued"
          workflow_conclusion: ''
          # Optional, will get head commit SHA
          pr: ${{ github.event.pull_request.number }}
          # Optional, no need to specify if PR is
          commit: ${{ github.event.pull_request.head.sha }}
          # Optional, will use the branch
          # branch: master
          # Optional, defaults to all types
          # event: push
          # Optional, will use specified workflow run
          # run_id: 1122334455
          # Optional, run number from the workflow
          # run_number: 34
          # Optional, uploaded artifact name,
          # will download all artifacts if not specified
          # and extract them into respective subdirectories
          # https://github.com/actions/download-artifact#download-all-artifacts
          name: MobileRT_${{ matrix.type }}_min_android_api-${{ matrix.android_api }}-apk
          # Optional, a directory where to extract artifact(s), defaults to the current directory
          path: .
          # Optional, defaults to current repo
          repo: ${{ github.repository }}
          allow_forks: true
          # Optional, check the workflow run to whether it has an artifact
          # then will get the last available artifact from the previous workflow
          # default false, just try to download from the last one
          check_artifacts:  true
          # Optional, search for the last workflow run whose stored an artifact named as in `name` input
          # default false
          search_artifacts: true
          # Optional, choose to skip unpacking the downloaded artifact(s)
          # default false
          skip_unpack: true
          # Optional, choose how to exit the action if no artifact is found
          # can be one of:
          #  "fail", "warn", "ignore"
          # default fail
          if_no_artifact_found: fail

    # Download generated Linux artifact
    # Taken from: https://github.com/marketplace/actions/download-workflow-artifact
    - name: Download Linux packages artifact
      id: download-linux-artifact
      timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
      if: success()
      uses: Wandalen/wretry.action@e68c23e6309f2871ca8ae4763e7629b9c258e1ea # v3
      with:
        # Check available parameters in: https://github.com/Wandalen/wretry.action/blob/master/action.yml
        action: dawidd6/action-download-artifact@0bd50d53a6d7fb5cb921e607957e9cc12b4ce392 # v12
        pre_retry_command: 'echo "Retrying Download Linux packages artifact step..."'
        attempt_limit: 3
        attempt_delay: 30000
        with: |
          # Check available parameters in: https://github.com/dawidd6/action-download-artifact/blob/master/action.yml
          # Optional, GitHub token, a Personal Access Token with `public_repo` scope if needed
          # Required, if the artifact is from a different repo
          # Required, if the repo is private a Personal Access Token with `repo` scope is needed
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # Optional, workflow file name or ID
          # If not specified, will be inferred from run_id (if run_id is specified), or will be the current workflow
          workflow: release.yml
          # Optional, the status or conclusion of a completed workflow to search for
          # Can be one of a workflow conclusion:
          #   "failure", "success", "neutral", "cancelled", "skipped", "timed_out", "action_required"
          # Or a workflow status:
          #   "completed", "in_progress", "queued"
          workflow_conclusion: ''
          # Optional, will get head commit SHA
          pr: ${{ github.event.pull_request.number }}
          # Optional, no need to specify if PR is
          commit: ${{ github.event.pull_request.head.sha }}
          # Optional, will use the branch
          # branch: master
          # Optional, defaults to all types
          # event: push
          # Optional, will use specified workflow run
          # run_id: 1122334455
          # Optional, run number from the workflow
          # run_number: 34
          # Optional, uploaded artifact name,
          # will download all artifacts if not specified
          # and extract them into respective subdirectories
          # https://github.com/actions/download-artifact#download-all-artifacts
          name: MobileRT_release_os-ubuntu-24.04_build-g++
          # Optional, a directory where to extract artifact(s), defaults to the current directory
          path: .
          # Optional, defaults to current repo
          repo: ${{ github.repository }}
          allow_forks: true
          # Optional, check the workflow run to whether it has an artifact
          # then will get the last available artifact from the previous workflow
          # default false, just try to download from the last one
          check_artifacts:  true
          # Optional, search for the last workflow run whose stored an artifact named as in `name` input
          # default false
          search_artifacts: true
          # Optional, choose to skip unpacking the downloaded artifact(s)
          # default false
          skip_unpack: true
          # Optional, choose how to exit the action if no artifact is found
          # can be one of:
          #  "fail", "warn", "ignore"
          # default fail
          if_no_artifact_found: fail

    # Download generated MacOS artifact
    # Taken from: https://github.com/marketplace/actions/download-workflow-artifact
    - name: Download MacOS packages artifact
      id: download-macos-artifact
      timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
      if: success()
      uses: Wandalen/wretry.action@e68c23e6309f2871ca8ae4763e7629b9c258e1ea # v3
      with:
        # Check available parameters in: https://github.com/Wandalen/wretry.action/blob/master/action.yml
        action: dawidd6/action-download-artifact@0bd50d53a6d7fb5cb921e607957e9cc12b4ce392 # v12
        pre_retry_command: 'echo "Retrying Download MacOS packages artifact step..."'
        attempt_limit: 3
        attempt_delay: 30000
        with: |
          # Check available parameters in: https://github.com/dawidd6/action-download-artifact/blob/master/action.yml
          # Optional, GitHub token, a Personal Access Token with `public_repo` scope if needed
          # Required, if the artifact is from a different repo
          # Required, if the repo is private a Personal Access Token with `repo` scope is needed
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # Optional, workflow file name or ID
          # If not specified, will be inferred from run_id (if run_id is specified), or will be the current workflow
          workflow: release.yml
          # Optional, the status or conclusion of a completed workflow to search for
          # Can be one of a workflow conclusion:
          #   "failure", "success", "neutral", "cancelled", "skipped", "timed_out", "action_required"
          # Or a workflow status:
          #   "completed", "in_progress", "queued"
          workflow_conclusion: ''
          # Optional, will get head commit SHA
          pr: ${{ github.event.pull_request.number }}
          # Optional, no need to specify if PR is
          commit: ${{ github.event.pull_request.head.sha }}
          # Optional, will use the branch
          # branch: master
          # Optional, defaults to all types
          # event: push
          # Optional, will use specified workflow run
          # run_id: 1122334455
          # Optional, run number from the workflow
          # run_number: 34
          # Optional, uploaded artifact name,
          # will download all artifacts if not specified
          # and extract them into respective subdirectories
          # https://github.com/actions/download-artifact#download-all-artifacts
          name: MobileRT_release_os-macos-15_build-g++
          # Optional, a directory where to extract artifact(s), defaults to the current directory
          path: .
          # Optional, defaults to current repo
          repo: ${{ github.repository }}
          allow_forks: true
          # Optional, check the workflow run to whether it has an artifact
          # then will get the last available artifact from the previous workflow
          # default false, just try to download from the last one
          check_artifacts:  true
          # Optional, search for the last workflow run whose stored an artifact named as in `name` input
          # default false
          search_artifacts: true
          # Optional, choose to skip unpacking the downloaded artifact(s)
          # default false
          skip_unpack: true
          # Optional, choose how to exit the action if no artifact is found
          # can be one of:
          #  "fail", "warn", "ignore"
          # default fail
          if_no_artifact_found: fail

    # Download generated Windows artifact
    # Taken from: https://github.com/marketplace/actions/download-workflow-artifact
    - name: Download Windows packages artifact
      id: download-windows-artifact
      timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
      if: success()
      uses: Wandalen/wretry.action@e68c23e6309f2871ca8ae4763e7629b9c258e1ea # v3
      with:
        # Check available parameters in: https://github.com/Wandalen/wretry.action/blob/master/action.yml
        action: dawidd6/action-download-artifact@0bd50d53a6d7fb5cb921e607957e9cc12b4ce392 # v12
        pre_retry_command: 'echo "Retrying Download Windows packages artifact step..."'
        attempt_limit: 3
        attempt_delay: 30000
        with: |
          # Check available parameters in: https://github.com/dawidd6/action-download-artifact/blob/master/action.yml
          # Optional, GitHub token, a Personal Access Token with `public_repo` scope if needed
          # Required, if the artifact is from a different repo
          # Required, if the repo is private a Personal Access Token with `repo` scope is needed
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # Optional, workflow file name or ID
          # If not specified, will be inferred from run_id (if run_id is specified), or will be the current workflow
          workflow: release.yml
          # Optional, the status or conclusion of a completed workflow to search for
          # Can be one of a workflow conclusion:
          #   "failure", "success", "neutral", "cancelled", "skipped", "timed_out", "action_required"
          # Or a workflow status:
          #   "completed", "in_progress", "queued"
          workflow_conclusion: ''
          # Optional, will get head commit SHA
          pr: ${{ github.event.pull_request.number }}
          # Optional, no need to specify if PR is
          commit: ${{ github.event.pull_request.head.sha }}
          # Optional, will use the branch
          # branch: master
          # Optional, defaults to all types
          # event: push
          # Optional, will use specified workflow run
          # run_id: 1122334455
          # Optional, run number from the workflow
          # run_number: 34
          # Optional, uploaded artifact name,
          # will download all artifacts if not specified
          # and extract them into respective subdirectories
          # https://github.com/actions/download-artifact#download-all-artifacts
          name: MobileRT_release_os-windows-11-arm_build-cl
          # Optional, a directory where to extract artifact(s), defaults to the current directory
          path: .
          # Optional, defaults to current repo
          repo: ${{ github.repository }}
          allow_forks: true
          # Optional, check the workflow run to whether it has an artifact
          # then will get the last available artifact from the previous workflow
          # default false, just try to download from the last one
          check_artifacts:  true
          # Optional, search for the last workflow run whose stored an artifact named as in `name` input
          # default false
          search_artifacts: true
          # Optional, choose to skip unpacking the downloaded artifact(s)
          # default false
          skip_unpack: true
          # Optional, choose how to exit the action if no artifact is found
          # can be one of:
          #  "fail", "warn", "ignore"
          # default fail
          if_no_artifact_found: fail

    - name: Extract & validate release artifacts
      timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
      if: success()
      run: |
        mkdir -p release/android;
        mkdir -p release/linux;
        mkdir -p release/macos;
        mkdir -p release/windows;

        mv MobileRT_release_min_android_api-15-apk.zip release/android;
        ls -lahp release/android/MobileRT_release_min_android_api-15-apk.zip;
        . scripts/helper_functions.sh && extractFilesFromArtifact release/android;
        mv release/android/app-release-signed.apk release/android/MobileRT_${{ matrix.type }}_min_android_api-${{ matrix.android_api }}.apk;
        ls -lahp release/android/MobileRT_${{ matrix.type }}_min_android_api-${{ matrix.android_api }}.apk;

        mv MobileRT_release_os-ubuntu-24.04_build-g++.zip release/linux;
        ls -lahp release/linux/MobileRT_release_os-ubuntu-24.04_build-g++.zip;

        mv MobileRT_release_os-macos-15_build-g++.zip release/macos;
        ls -lahp release/macos/MobileRT_release_os-macos-15_build-g++.zip;

        mv MobileRT_release_os-windows-11-arm_build-cl.zip release/windows;
        ls -lahp release/windows/MobileRT_release_os-windows-11-arm_build-cl.zip;

        ls -lahpR release;
        echo "Release notes: ${{ needs.ReleaseNotes.outputs.release_notes }}";

    - name: Release
      timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
      uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
      if: github.ref_type == 'tag'
      with:
        # Check available parameters in: https://github.com/softprops/action-gh-release/blob/master/action.yml
        body: ${{ needs.ReleaseNotes.outputs.release_notes }}
        draft: true # TODO: change to false when ready to publish
        prerelease: false
        preserve_order: true
        files: |
          release/android/MobileRT_${{ matrix.type }}_min_android_api-${{ matrix.android_api }}.apk
          release/linux/MobileRT_release_os-ubuntu-24.04_build-g++.zip
          release/macos/MobileRT_release_os-macos-15_build-g++.zip
          release/windows/MobileRT_release_os-windows-11-arm_build-cl.zip
        fail_on_unmatched_files: true
        generate_release_notes: false
        append_body: false
        make_latest: true

    - name: Upload APK to Google Play
      timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
      uses: r0adkll/upload-google-play@935ef9c68bb393a8e6116b1575626a7f5be3a7fb # v1
      if: github.ref_type == 'tag' && false # TODO: Enable when ready to publish
      with:
        # Check available parameters in: https://github.com/r0adkll/upload-google-play/blob/master/action.yml
        serviceAccountJsonPlainText: ${{ secrets.SERVICE_ACCOUNT_JSON }}
        packageName: puscas.mobilertapp
        releaseFiles: release/android/MobileRT_${{ matrix.type }}_min_android_api-${{ matrix.android_api }}.apk
        track: internal # TODO: change to 'production' when ready to publish
        inAppUpdatePriority: 0 # TODO: change to 5 when ready to publish
        status: draft # TODO: change to 'completed' when ready to publish
        changesNotSentForReview: true # TODO: change to false when ready to publish
