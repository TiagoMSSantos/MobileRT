name: Build Native (Qt)

on:
  push:
    paths-ignore:
    - '*'
    - '.github/**'
    - 'app/*'
    - 'app/debug/**'
    - 'app/release/**'
    - 'app/System_dependent/**'
    - 'app/src/**'
    - 'docker_image/**'
    - 'docs/**'
    - 'gradle/**'
    - 'scripts/**'
    - 'WavefrontOBJs/**'
    - '!.github/workflows/native.yml'
    - '!app/CMakeLists.txt'
    - '!app/System_dependent/CMakeLists.txt'
    - '!app/System_dependent/Native/**'
    - '!scripts/compile_native.sh'
    - '!codecov.yml'
#branches-ignore:
#  - '**'

defaults:
  run:
    shell: bash
    working-directory: .

jobs:
  Build:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-10.15, ubuntu-18.04]
        type: [release]
        compiler: [g++, clang++]

    name: ${{ matrix.type }} ${{ matrix.compiler }} (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    steps:
    - name: Checkout
      uses: actions/checkout@v2.3.4

    - name: Setup build directory
      if: success()
      working-directory: .
      run: |
        mkdir -p build_${{ matrix.type }};

    - name: Setup code climate report
      if: success()
      working-directory: .
      run: |
        mkdir -p ./reports;
        chmod +x ./test-reporter-latest-linux-amd64 2>&1 | tee ./reports/setup_code_climate.log;
        export res="${PIPESTATUS[0]}";
        echo "Result: '${res}'";
        exit ${res};

    - name: Install Dependencies
      if: success()
      working-directory: .
      run: |
        bash scripts/install_dependencies.sh;

    - name: Create symlink of headers MacOS
      if: success() && startsWith(matrix.os, 'macos') && matrix.compiler == 'g++'
      working-directory: .
      run: |
        ln -s /usr/local/Cellar/qt@4/4.8.7_6/lib/QtGui.framework/Versions/4/Headers/* /usr/local/include/QtGui/ || true 2>&1 | tee ./reports/create_symlinks_headers.log;
        export res="${PIPESTATUS[0]}";
        echo "Result: '${res}'";
        exit ${res};

    - name: Build ${{ matrix.type }}
      if: success()
      working-directory: .
      run: |
        bash scripts/compile_native.sh ${{ matrix.type }} ${{ matrix.compiler }} 2>&1 | tee ./reports/run_cmake.log;
        export res="${PIPESTATUS[0]}";
        echo "Result: '${res}'";
        exit ${res};

    - name: Check build path
      if: success()
      working-directory: build_${{ matrix.type }}
      run: |
        find . -iname "*.so" 2> /dev/null;
        ls -Rla ./bin ./lib;

    - name: Generate code coverage base
      if: success() && matrix.compiler == 'g++' && matrix.type == 'Debug' && startsWith(matrix.os, 'ubuntu')
      working-directory: .
      run: |
        lcov -c -i -d . --no-external -o code_coverage_base.info 2>&1 | tee ./reports/generate_code_coverage_base.log;
        export res="${PIPESTATUS[0]}";
        echo "Result: '${res}'";
        exit ${res};

    - name: Run unit tests Debug
      if: success() && matrix.type == 'Debug'
      working-directory: build_${{ matrix.type }}
      run: |
        mkdir -p ./reports;
        DYLD_FALLBACK_LIBRARY_PATH=./lib ./bin/UnitTestsd 2>&1 | tee ./reports/unit_tests.log;
        export res="${PIPESTATUS[0]}";
        echo "Result: '${res}'";
        exit ${res};

    - name: Run unit tests Release
      if: success() && matrix.type == 'Release'
      working-directory: build_${{ matrix.type }}
      run: |
        mkdir -p ./reports;
        DYLD_FALLBACK_LIBRARY_PATH=./lib ./bin/UnitTests 2>&1 | tee ./reports/unit_tests.log;
        export res="${PIPESTATUS[0]}";
        echo "Result: '${res}'";
        exit ${res};

    - name: Generate code coverage
      if: success() && matrix.compiler == 'g++' && matrix.type == 'Debug' && startsWith(matrix.os, 'ubuntu')
      working-directory: .
      run: |
        lcov -c -d . --no-external -o code_coverage_test.info 2>&1 | tee ./reports/code_coverage_1.log;
        lcov -a code_coverage_base.info -a code_coverage_test.info -o code_coverage.info 2>&1 | tee ./reports/code_coverage_2.log;
        lcov --remove code_coverage.info -o code_coverage.info '*third_party*' '*build*' 2>&1 | tee ./reports/code_coverage_3.log;
        genhtml code_coverage.info -o code_coverage_report --no-branch-coverage -t MobileRT_code_coverage  2>&1 | tee ./reports/code_coverage_4.log;
        export res="${PIPESTATUS[0]}";
        echo "Result: '${res}'";
        exit ${res};

    - name: Send code climate report
      if: success() && matrix.compiler == 'g++' && matrix.type == 'Debug' && startsWith(matrix.os, 'ubuntu')
      working-directory: .
      env:
        CC_TEST_REPORTER_ID: ${{ secrets.CC_TEST_REPORTER_ID }}
      run: |
        ./test-reporter-latest-linux-amd64 format-coverage -t lcov code_coverage.info 2>&1 | tee ./reports/format_coverage.log;
        ./test-reporter-latest-linux-amd64 upload-coverage 2>&1 | tee ./reports/upload_coverage.log;
        export res="${PIPESTATUS[0]}";
        echo "Result: '${res}'";
        exit ${res};

    - name: Validate codecov report
      if: success() && matrix.compiler == 'g++' && matrix.type == 'Debug' && startsWith(matrix.os, 'ubuntu')
      working-directory: .
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      run: |
        curl --retry 5 --retry-delay 2 --connect-timeout 2 --data-binary @codecov.yml https://codecov.io/validate 2>&1 | tee ./reports/validate_codecov.log;
        export res="${PIPESTATUS[0]}";
        echo "Result: '${res}'";
        exit 0;

    - name: Send codecov report
      if: success() && matrix.compiler == 'g++' && matrix.type == 'Debug' && startsWith(matrix.os, 'ubuntu')
      working-directory: .
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      run: |
        curl --retry 5 --retry-delay 2 --connect-timeout 2 -s https://codecov.io/bash | bash -s -- -c -F aFlag ./build_${{ matrix.type }} -v 2>&1 | tee ./reports/send_codecov_report.log;
        export res="${PIPESTATUS[0]}";
        echo "Result: '${res}'";
        exit 0;

    - name: Upload reports
      if: always()
      uses: actions/upload-artifact@v2
      continue-on-error: true
      with:
        name: reports_${{ matrix.type }}_${{ matrix.os }}
        path: |
          ./reports
