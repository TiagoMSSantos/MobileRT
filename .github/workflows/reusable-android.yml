name: Reusable Android workflow

on:
  workflow_call:
    inputs:
      host_os:
        type: string
        required: true
      android_api:
        type: string
        required: true
      android_api_device:
        type: string
        required: true
      type:
        type: string
        required: true

permissions: {}

defaults:
  run:
    shell: sh
    working-directory: .

# Default environment variables.
env:
  GITHUB_STEP_TIMEOUT_SMALL: 4
  GITHUB_STEP_TIMEOUT_MEDIUM: 10
  GITHUB_STEP_TIMEOUT_LONG: 20

jobs:
  Build:
    runs-on: ${{ inputs.host_os }}
    name: Build ${{ inputs.android_api }} (${{ inputs.android_api_device }}) ${{ inputs.type }} (${{ inputs.host_os }})
    timeout-minutes: 360

    # Sets permissions of the GITHUB_TOKEN to allow delete cache
    permissions:
      actions: write

    steps:
      - name: Checkout
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success()
        uses: actions/checkout@v6
        with:
          # Check available parameters in: https://github.com/actions/checkout/blob/main/action.yml
          lfs: true

      - name: Add custom environment variables
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_LONG) }}
        if: success()
        run: |
          echo 'Available Android versions:';
          du -h -d 1 ${ANDROID_HOME}/ndk;
          du -h -d 1 ${ANDROID_HOME}/cmake || true;
          du -h -d 1 ${ANDROID_HOME}/build-tools;
          du -h -d 1 ${ANDROID_HOME}/platforms;
          du -h -d 1 ${ANDROID_HOME}/extras;
          du -h -d 1 ${ANDROID_HOME};
          du -h -d 1 ${HOME};
          echo "GRADLE_PATH=${HOME}/.gradle" >> "${GITHUB_ENV}";
          df -Pk -h ${HOME};
          env;

      # Useful step to avoid gradle having to download Gradle dependencies
      # Taken from: https://github.com/marketplace/actions/download-workflow-artifact
      - name: Download Gradle packages artifact
        id: download-gradle-artifact
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success() && !startsWith(inputs.host_os, 'windows')
        uses: dawidd6/action-download-artifact@0bd50d53a6d7fb5cb921e607957e9cc12b4ce392 # v12
        continue-on-error: true
        with:
          # Check available parameters in: https://github.com/dawidd6/action-download-artifact/blob/master/action.yml
          # Optional, GitHub token, a Personal Access Token with `public_repo` scope if needed
          # Required, if the artifact is from a different repo
          # Required, if the repo is private a Personal Access Token with `repo` scope is needed
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # Optional, workflow file name or ID
          # If not specified, will be inferred from run_id (if run_id is specified), or will be the current workflow
          workflow: android.yml
          # Optional, the status or conclusion of a completed workflow to search for
          # Can be one of a workflow conclusion:
          #   "failure", "success", "neutral", "cancelled", "skipped", "timed_out", "action_required"
          # Or a workflow status:
          #   "completed", "in_progress", "queued"
          workflow_conclusion: ''
          # Optional, will get head commit SHA
          pr: ${{ github.event.pull_request.number }}
          # Optional, no need to specify if PR is
          commit: ${{ github.event.pull_request.head.sha }}
          # Optional, will use the branch
          # branch: master
          # Optional, defaults to all types
          # event: push
          # Optional, will use specified workflow run
          # run_id: 1122334455
          # Optional, run number from the workflow
          # run_number: 34
          # Optional, uploaded artifact name,
          # will download all artifacts if not specified
          # and extract them into respective subdirectories
          # https://github.com/actions/download-artifact#download-all-artifacts
          name: gradle-packages
          # Optional, a directory where to extract artifact(s), defaults to the current directory
          path: ${{ env.GRADLE_PATH }}
          # Optional, defaults to current repo
          repo: ${{ github.repository }}
          allow_forks: true
          # Optional, check the workflow run to whether it has an artifact
          # then will get the last available artifact from the previous workflow
          # default false, just try to download from the last one
          check_artifacts:  true
          # Optional, search for the last workflow run whose stored an artifact named as in `name` input
          # default false
          search_artifacts: true
          # Optional, choose to skip unpacking the downloaded artifact(s)
          # default false
          skip_unpack: true
          # Optional, choose how to exit the action if no artifact is found
          # can be one of:
          #  "fail", "warn", "ignore"
          # default fail
          if_no_artifact_found: fail

      - name: Extract and check files from gradle artifact
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success() && steps.download-gradle-artifact.outputs.found_artifact == 'true'
        run: |
          ls -lahp ${{ env.GRADLE_PATH }}/gradle-packages.zip;
          # shellcheck disable=SC1091
          . scripts/helper_functions.sh && extractFilesFromArtifact ${{ env.GRADLE_PATH }};
          set +e;
          find ${{ env.GRADLE_PATH }} -name "transforms" -exec rm -rf {} \;
          set -e;

      - name: Validate codecov config
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success() && inputs.type == 'debug'
        run: |
          curl --fail-with-body -S --retry 5 --retry-delay 2 --connect-timeout 2 --data-binary @codecov.yml https://codecov.io/validate;

      - name: Set up JDK
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success()
        uses: actions/setup-java@v5
        with:
          # Check available parameters in: https://github.com/actions/setup-java/blob/main/action.yml
          java-version: 21
          distribution: zulu
          java-package: jdk
          check-latest: false
          server-id: github
          server-username: GITHUB_ACTOR
          server-password: GITHUB_TOKEN
          settings-path: ~/.gradle
          overwrite-settings: true
          gpg-private-key: ''
          gpg-passphrase: GPG_PASSPHRASE
          cache-dependency-path: '**/build.gradle'

      - name: Set Android CPU Architecture
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        run: |
          set +eu;
          MAJOR_MAC_VERSION=$(sw_vers | grep ProductVersion | cut -d ':' -f2 | cut -d '.' -f1 | tr -d '[:space:]');
          if [ "${MAJOR_MAC_VERSION}" != '' ]; then
            echo "MacOS '${MAJOR_MAC_VERSION}' detected";
          fi
          set -e;
          if ${{ endsWith(inputs.host_os, '-arm') }} = true || "${MAJOR_MAC_VERSION}" -gt 13; then
              echo 'android_arch=\"arm64-v8a\"' >> "${GITHUB_ENV}";
              echo 'android_emulator_arch=arm64-v8a' >> "${GITHUB_ENV}";
          else
            if [ "${{ inputs.android_api_device }}" -gt 20 ]; then
              echo 'android_arch=\"x86_64\"' >> "${GITHUB_ENV}";
              echo 'android_emulator_arch=x86_64' >> "${GITHUB_ENV}";
            else
              echo 'android_arch=\"x86\"' >> "${GITHUB_ENV}";
              echo 'android_emulator_arch=x86' >> "${GITHUB_ENV}";
            fi
          fi
          set -u;

      - name: Download Android CMake
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success() && !startsWith(inputs.host_os, 'windows')
        run: |
          . scripts/helper_functions.sh && callCommandUntilSuccess 2 timeout 180 ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --install 'cmake;4.0.2';

      - name: Download Android CMake Windows
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success() && startsWith(inputs.host_os, 'windows')
        run: |
          . scripts/helper_functions.sh && callCommandUntilSuccess 2 timeout 180 ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager.bat --install 'cmake;4.0.2';

      - name: Download NDK
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success() && !startsWith(inputs.host_os, 'windows')
        run: |
          if [ "${{ inputs.android_api }}" -ge 21 ]; then
            export NDK_VERSION='29.0.14206865';
          elif [ "${{ inputs.android_api }}" -ge 19 ]; then
            export NDK_VERSION='25.2.9519653';
          else
            export NDK_VERSION='23.2.8568313';
          fi
          . scripts/helper_functions.sh && callCommandUntilSuccess 2 timeout 180 ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --install "ndk;${NDK_VERSION}";

      - name: Download NDK Windows
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success() && startsWith(inputs.host_os, 'windows')
        run: |
          if [ "${{ inputs.android_api }}" -ge 21 ]; then
            export NDK_VERSION='29.0.14206865';
          elif [ "${{ inputs.android_api }}" -ge 19 ]; then
            export NDK_VERSION='25.2.9519653';
          else
            export NDK_VERSION='23.2.8568313';
          fi
          . scripts/helper_functions.sh && callCommandUntilSuccess 2 timeout 180 ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager.bat --install "ndk;${NDK_VERSION}";

      - name: Download Android dependencies
        timeout-minutes: 8
        if: success()
        run: |
          . scripts/helper_functions.sh && callCommandUntilSuccess 2 timeout 180 sh gradlew build --dry-run -Dorg.gradle.configuration-cache=false --parallel \
            -DtestType="${{ inputs.type }}" -DandroidApiVersion="${{ inputs.android_api }}" -DabiFilters="[${{ env.android_arch }}]" \
            --info --warning-mode all --stacktrace;

      - name: Build ${{ inputs.type }}
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_LONG) }}
        if: success()
        env:
          ANDROID_KEYSTORE_PASSWORD_DEBUG: ${{ secrets.ANDROID_KEYSTORE_PASSWORD_DEBUG }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD_DEBUG: ${{ secrets.ANDROID_KEY_PASSWORD_DEBUG }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_KEY_ALIAS_DEBUG: ${{ secrets.ANDROID_KEY_ALIAS_DEBUG }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          echo "${{ secrets.ANDROID_SIGNING_KEY_BASE64 }}" | base64 -d > app/MobileRT.jks;
          echo "android_arch: ${{ env.android_arch }}";
          echo "android_emulator_arch: ${{ env.android_emulator_arch }}";
          sh scripts/compile_android.sh -t ${{ inputs.type }} -r yes -a ${{ inputs.android_api }} -f ${{ env.android_arch }};
          rm app/MobileRT.jks;

      - name: Print error logs
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: failure()
        run: |
          ls -lahp .;
          set +e;
          echo 'Print JVM errors if provided by Kernel, and just check the logs from the last line of the previous call:';
          sudo dmesg -T;
          echo 'Print native JVM stacktrace if possible:';
          cat hs_err_pid*.log;
          set -e;

      - name: Upload problems reports as artifact
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          # Check available parameters in: https://github.com/actions/upload-artifact/blob/main/action.yml
          name: problems-report
          path: |
            build/reports
            app/build/reports
          if-no-files-found: error
          retention-days: 90
          overwrite: true
          include-hidden-files: true

      - name: Check binaries' paths
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        run: |
          find app/build/ -iname "*.class";
          # shellcheck disable=SC1091
          . scripts/helper_functions.sh && checkPathExists app/build;
          . scripts/helper_functions.sh && checkPathExists app/build/intermediates;
          . scripts/helper_functions.sh && checkPathExists app/build/intermediates/javac;
          . scripts/helper_functions.sh && checkPathExists app/build/intermediates/javac/debug;
          . scripts/helper_functions.sh && checkPathExists app/.cxx;
          . scripts/helper_functions.sh && checkPathExists app/third_party;
          . scripts/helper_functions.sh && checkPathExists ${{ env.GRADLE_PATH }};
          if [ "${{ inputs.android_api }}" -gt 15 ]; then
            typeWithCapitalLetter=$(. scripts/helper_functions.sh && capitalizeFirstletter ${{ inputs.type }});
            . scripts/helper_functions.sh && checkPathExists app/build/intermediates/javac/${{ inputs.type }}/compile${typeWithCapitalLetter}JavaWithJavac/classes;
            # . scripts/helper_functions.sh && checkPathExists app/build/intermediates/built_in_kotlinc/${{ inputs.type }}/compile${typeWithCapitalLetter}Kotlin/classes;
          else
            . scripts/helper_functions.sh && checkPathExists app/build/tmp/kotlin-classes/debug;
          fi

      - name: Upload generated binaries to cache
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        uses: actions/cache/save@v5
        with:
          # Check available parameters in: https://github.com/actions/cache/blob/main/save/action.yml
          key: compiled_${{ github.sha }}_${{ github.run_id }}_${{ github.run_number }}_a${{ inputs.android_api }}_d${{ inputs.android_api_device }}_${{ inputs.type }}_${{ inputs.host_os }}
          upload-chunk-size: 536870912
          enableCrossOsArchive: false
          path: |
            app/build
            app/.cxx
            app/third_party

      - name: Zip Gradle packages
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success() && !startsWith(inputs.host_os, 'windows')
        run: |
          set +e;
          du -h -d 1 ${{ env.GRADLE_PATH }};
          du -h -d 1 ${{ env.GRADLE_PATH }}/caches;
          du -h -d 1 ${{ env.GRADLE_PATH }}/wrapper/dists;
          du -h -d 1 ${{ env.GRADLE_PATH }}/daemon;
          du -h -d 1 ${{ env.GRADLE_PATH }}/notifications;
          du -h -d 1 ${{ env.GRADLE_PATH }}/jdks;
          du -h -d 1 ${{ env.GRADLE_PATH }}/kotlin-profile;
          du -h -d 1 ${{ env.GRADLE_PATH }}/workers;
          du -h -d 1 ${{ env.GRADLE_PATH }}/native;

          echo 'Deleting unnecessary cache.';
          rm -rf ${{ env.GRADLE_PATH }}/caches/build-cache-*;
          rm -rf ${{ env.GRADLE_PATH }}/caches/journal-*;
          rm -rf ${{ env.GRADLE_PATH }}/caches/transforms-4;
          rm -rf ${{ env.GRADLE_PATH }}/daemon;
          rm -rf ${{ env.GRADLE_PATH }}/jdks;
          rm -rf ${{ env.GRADLE_PATH }}/kotlin-profile;
          rm -rf ${{ env.GRADLE_PATH }}/workers;
          rm -rf ${{ env.GRADLE_PATH }}/native;
          rm -rf ${{ env.GRADLE_PATH }}/.tmp;
          rm -rf ${{ env.GRADLE_PATH }}/notifications;

          find ${{ env.GRADLE_PATH }}/wrapper/dists -not -iname '*gradle*.zip' -delete;
          find ${{ env.GRADLE_PATH }} -iname "docs" -exec rm -rf {} \;
          find ${{ env.GRADLE_PATH }} -iname "*.log*" -exec rm -rf {} \;
          find ${{ env.GRADLE_PATH }} -iname "*.txt*" -exec rm -rf {} \;
          find ${{ env.GRADLE_PATH }} -iname "*.md*" -exec rm -rf {} \;
          find ${{ env.GRADLE_PATH }} -iname "*.doc*" -exec rm -rf {} \;
          find ${{ env.GRADLE_PATH }} -iname "*.xls*" -exec rm -rf {} \;
          find ${{ env.GRADLE_PATH }} -iname "*.htm*" -exec rm -rf {} \;
          find ${{ env.GRADLE_PATH }} -iname "*.lock*" -exec rm -rf {} \;
          find ${{ env.GRADLE_PATH }} -iname "*.lck*" -exec rm -rf {} \;
          find ${{ env.GRADLE_PATH }} -iname "*.ok*" -exec rm -rf {} \;
          find ${{ env.GRADLE_PATH }} -iname "*.png*" -exec rm -rf {} \;
          find ${{ env.GRADLE_PATH }} -iname "*.jpg*" -exec rm -rf {} \;
          find ${{ env.GRADLE_PATH }} -iname "*.jpeg*" -exec rm -rf {} \;
          find ${{ env.GRADLE_PATH }} -iname "*.gif*" -exec rm -rf {} \;
          find ${{ env.GRADLE_PATH }} -iname "*README*" -exec rm -rf {} \;
          find ${{ env.GRADLE_PATH }} -iname "*NOTICE*" -exec rm -rf {} \;
          find ${{ env.GRADLE_PATH }} -iname "*LICENSE*" -exec rm -rf {} \;
          find ${{ env.GRADLE_PATH }} -iname "transforms" -exec rm -rf {} \;

          find ${{ env.GRADLE_PATH }} -empty -exec rm -rf {} \;
          find ${{ env.GRADLE_PATH }} -size 0 -exec rm -rf {} \;
          set -e;

          # shellcheck disable=SC1091
          . scripts/helper_functions.sh && zipFilesForArtifact ${{ env.GRADLE_PATH }} gradle-packages.zip;

      - name: Upload Gradle packages as artifact
        timeout-minutes: 20
        if: success() && strategy.job-index == 0 && !startsWith(inputs.host_os, 'windows')
        continue-on-error: true
        uses: actions/upload-artifact@v6
        with:
          # Check available parameters in: https://github.com/actions/upload-artifact/blob/main/action.yml
          name: gradle-packages
          path: ${{ env.GRADLE_PATH }}/gradle-packages.zip
          if-no-files-found: error
          retention-days: 90
          compression-level: 9
          overwrite: true
          include-hidden-files: true


  AndroidTests:
    needs: [Build]
    name: Android tests ${{ inputs.android_api }} (${{ inputs.android_api_device }}) ${{ inputs.type }} (${{ inputs.host_os }})
    runs-on: ${{ inputs.host_os }}
    timeout-minutes: 360

    # Sets permissions of the GITHUB_TOKEN to allow delete cache and publish test results
    permissions:
      actions: write
      checks: write
      pull-requests: write # only required if `comment: true` was enabled

    steps:
      - name: Checkout
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success()
        uses: actions/checkout@v6
        with:
          # Check available parameters in: https://github.com/actions/checkout/blob/main/action.yml
          lfs: true

      - name: Add custom environment variables
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_LONG) }}
        if: success()
        run: |
          echo 'Available Android versions:';
          du -h -d 1 ${ANDROID_HOME};
          rm -rf ${ANDROID_HOME}/ndk;
          rm -rf ${ANDROID_HOME}/extras;
          rm -rf ${ANDROID_HOME}/cmake;
          mkdir -p ${ANDROID_HOME}/ndk;
          mkdir -p ${ANDROID_HOME}/extras;
          mkdir -p ${ANDROID_HOME}/cmake;
          du -h -d 1 ${ANDROID_HOME}/ndk;
          du -h -d 1 ${ANDROID_HOME}/cmake;
          du -h -d 1 ${ANDROID_HOME}/build-tools;
          du -h -d 1 ${ANDROID_HOME}/platforms;
          du -h -d 1 ${ANDROID_HOME}/extras;
          du -h -d 1 ${HOME};
          echo "GRADLE_PATH=${HOME}/.gradle" >> "${GITHUB_ENV}";
          df -Pk -h ${HOME};
          env;
          sudo rm -rf /usr/lib/jvm;
          sudo rm -rf /usr/share/dotnet;
          sudo rm -rf /usr/share/swift;
          sudo rm -rf /usr/local/.ghcup;
          sudo rm -rf /usr/local/julia*;
          sudo rm -rf /usr/local/share/chromium;
          sudo rm -rf /opt/microsoft;
          sudo rm -rf /opt/google;
          sudo rm -rf /opt/az;
          sudo rm -rf /usr/local/share/powershell;
          sudo rm -rf /opt/hostedtoolcache;
          docker rm -f "$(docker ps -a | awk 'NR>1 {print $1}')" || true;
          docker system prune --volumes --force;
          docker network prune --force;
          docker volume prune --force;
          docker system prune --all --force;
          docker builder prune --all --force;
          docker system df;
          df -h;

      # Useful step to avoid gradle having to download Gradle dependencies
      # Taken from: https://github.com/marketplace/actions/download-workflow-artifact
      - name: Download Gradle packages artifact
        id: download-gradle-artifact
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success() && !startsWith(inputs.host_os, 'windows')
        uses: Wandalen/wretry.action@e68c23e6309f2871ca8ae4763e7629b9c258e1ea # v3
        with:
          # Check available parameters in: https://github.com/Wandalen/wretry.action/blob/master/action.yml
          action: dawidd6/action-download-artifact@0bd50d53a6d7fb5cb921e607957e9cc12b4ce392 # v12
          pre_retry_command: 'echo "Retrying Download Gradle packages artifact step..."'
          attempt_limit: 3
          attempt_delay: 30000
          with: |
            # Check available parameters in: https://github.com/dawidd6/action-download-artifact/blob/master/action.yml
            # Optional, GitHub token, a Personal Access Token with `public_repo` scope if needed
            # Required, if the artifact is from a different repo
            # Required, if the repo is private a Personal Access Token with `repo` scope is needed
            github_token: ${{ secrets.GITHUB_TOKEN }}
            # Optional, workflow file name or ID
            # If not specified, will be inferred from run_id (if run_id is specified), or will be the current workflow
            workflow: android.yml
            # Optional, the status or conclusion of a completed workflow to search for
            # Can be one of a workflow conclusion:
            #   "failure", "success", "neutral", "cancelled", "skipped", "timed_out", "action_required"
            # Or a workflow status:
            #   "completed", "in_progress", "queued"
            workflow_conclusion: ''
            # Optional, will get head commit SHA
            pr: ${{ github.event.pull_request.number }}
            # Optional, no need to specify if PR is
            commit: ${{ github.event.pull_request.head.sha }}
            # Optional, will use the branch
            # branch: master
            # Optional, defaults to all types
            # event: push
            # Optional, will use specified workflow run
            # run_id: 1122334455
            # Optional, run number from the workflow
            # run_number: 34
            # Optional, uploaded artifact name,
            # will download all artifacts if not specified
            # and extract them into respective subdirectories
            # https://github.com/actions/download-artifact#download-all-artifacts
            name: gradle-packages
            # Optional, a directory where to extract artifact(s), defaults to the current directory
            path: ${{ env.GRADLE_PATH }}
            # Optional, defaults to current repo
            repo: ${{ github.repository }}
            allow_forks: true
            # Optional, check the workflow run to whether it has an artifact
            # then will get the last available artifact from the previous workflow
            # default false, just try to download from the last one
            check_artifacts:  true
            # Optional, search for the last workflow run whose stored an artifact named as in `name` input
            # default false
            search_artifacts: true
            # Optional, choose to skip unpacking the downloaded artifact(s)
            # default false
            skip_unpack: true
            # Optional, choose how to exit the action if no artifact is found
            # can be one of:
            #  "fail", "warn", "ignore"
            # default fail
            if_no_artifact_found: fail

      - name: Extract and check files from gradle artifact
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success() && !startsWith(inputs.host_os, 'windows')
        run: |
          ls -lahp ${{ env.GRADLE_PATH }}/gradle-packages.zip;
          # shellcheck disable=SC1091
          . scripts/helper_functions.sh && extractFilesFromArtifact ${{ env.GRADLE_PATH }};

      - name: Set up JDK
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success()
        uses: actions/setup-java@v5
        with:
          # Check available parameters in: https://github.com/actions/setup-java/blob/main/action.yml
          java-version: 21
          distribution: zulu
          java-package: jdk
          check-latest: false
          server-id: github
          server-username: GITHUB_ACTOR
          server-password: GITHUB_TOKEN
          settings-path: ~/.gradle
          overwrite-settings: true
          gpg-private-key: ''
          gpg-passphrase: GPG_PASSPHRASE
          cache-dependency-path: '**/build.gradle'

      - name: Download generated binaries from cache
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success()
        uses: actions/cache/restore@v5
        with:
          # Check available parameters in: https://github.com/actions/cache/blob/main/restore/action.yml
          key: compiled_${{ github.sha }}_${{ github.run_id }}_${{ github.run_number }}_a${{ inputs.android_api }}_d${{ inputs.android_api_device }}_${{ inputs.type }}_${{ inputs.host_os }}
          restore-keys: compiled_${{ github.sha }}_${{ github.run_id }}_${{ github.run_number }}_a${{ inputs.android_api }}_d${{ inputs.android_api_device }}_${{ inputs.type }}_${{ inputs.host_os }}
          enableCrossOsArchive: false
          fail-on-cache-miss: true
          lookup-only: false
          path: |
            app/build
            app/.cxx
            app/third_party

      - name: Check binaries' paths
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        run: |
          find app/build/ -iname "*.class";
          # shellcheck disable=SC1091
          . scripts/helper_functions.sh && checkPathExists app/build;
          . scripts/helper_functions.sh && checkPathExists app/build/intermediates;
          . scripts/helper_functions.sh && checkPathExists app/build/intermediates/javac;
          . scripts/helper_functions.sh && checkPathExists app/build/intermediates/javac/debug;
          . scripts/helper_functions.sh && checkPathExists app/.cxx;
          . scripts/helper_functions.sh && checkPathExists app/third_party;
          . scripts/helper_functions.sh && checkPathExists ${{ env.GRADLE_PATH }};
          if [ "${{ inputs.android_api }}" -gt 15 ]; then
            typeWithCapitalLetter=$(. scripts/helper_functions.sh && capitalizeFirstletter ${{ inputs.type }});
            . scripts/helper_functions.sh && checkPathExists app/build/intermediates/javac/${{ inputs.type }}/compile${typeWithCapitalLetter}JavaWithJavac/classes;
            # . scripts/helper_functions.sh && checkPathExists app/build/intermediates/built_in_kotlinc/${{ inputs.type }}/compile${typeWithCapitalLetter}Kotlin/classes;
          else
            . scripts/helper_functions.sh && checkPathExists app/build/tmp/kotlin-classes/debug;
          fi

      - name: Enable KVM group permissions
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success() && startsWith(inputs.host_os, 'ubuntu')
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules;
          sudo udevadm control --reload-rules;
          sudo udevadm trigger --name-match=kvm;

      - name: Set Android CPU Architecture
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        run: |
          set +eu;
          MAJOR_MAC_VERSION=$(sw_vers | grep ProductVersion | cut -d ':' -f2 | cut -d '.' -f1 | tr -d '[:space:]');
          if [ "${MAJOR_MAC_VERSION}" != '' ]; then
            echo "MacOS '${MAJOR_MAC_VERSION}' detected";
          fi
          set -e;
          if ${{ endsWith(inputs.host_os, '-arm') }} = true || "${MAJOR_MAC_VERSION}" -gt 13; then
              echo 'android_arch=\"arm64-v8a\"' >> "${GITHUB_ENV}";
              echo 'android_emulator_arch=arm64-v8a' >> "${GITHUB_ENV}";
          else
            if [ "${{ inputs.android_api_device }}" -gt 20 ]; then
              echo 'android_arch=\"x86_64\"' >> "${GITHUB_ENV}";
              echo 'android_emulator_arch=x86_64' >> "${GITHUB_ENV}";
            else
              echo 'android_arch=\"x86\"' >> "${GITHUB_ENV}";
              echo 'android_emulator_arch=x86' >> "${GITHUB_ENV}";
            fi
          fi
          set -u;

      - name: Set CPU cores
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        run: |
          echo "android_arch: ${{ env.android_arch }}";
          echo "android_emulator_arch: ${{ env.android_emulator_arch }}";
          . scripts/helper_functions.sh && parallelizeBuild && echo "NCPU_CORES=${NCPU_CORES}" >> "${GITHUB_ENV}";

      - name: Download Android dependencies
        timeout-minutes: 8
        if: success()
        run: |
          if [ "${{ inputs.type }}" = 'debug' ]; then
            gradle_command='jacocoTestReport';
          else
            gradle_command='connectedAndroidTest';
          fi
          . scripts/helper_functions.sh && callCommandUntilSuccess 2 timeout 180 sh gradlew "${gradle_command}" --dry-run -Dorg.gradle.configuration-cache=false --parallel \
            -DtestType="${{ inputs.type }}" -DandroidApiVersion="${{ inputs.android_api }}" -DabiFilters="[${{ env.android_arch }}]" \
            --info --warning-mode all --stacktrace;

      - name: Run Android tests
        timeout-minutes: 50
        if: success() && !startsWith(inputs.host_os, 'windows')
        uses: Wandalen/wretry.action@e68c23e6309f2871ca8ae4763e7629b9c258e1ea # v3
        env:
          ANDROID_EMULATOR_WAIT_TIME_BEFORE_KILL: 10
          ANDROID_EMULATOR_MEM_MB: 3072
          ANDROID_EMULATOR_CPU_CORES: 2
          ANDROID_KEYSTORE_PASSWORD_DEBUG: ${{ secrets.ANDROID_KEYSTORE_PASSWORD_DEBUG }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD_DEBUG: ${{ secrets.ANDROID_KEY_PASSWORD_DEBUG }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_KEY_ALIAS_DEBUG: ${{ secrets.ANDROID_KEY_ALIAS_DEBUG }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        with:
          # Check available parameters in: https://github.com/Wandalen/wretry.action/blob/master/action.yml
          action: ReactiveCircus/android-emulator-runner@b530d96654c385303d652368551fb075bc2f0b6b # v2
          pre_retry_command: 'echo "Retrying Run Android tests step..."'
          attempt_limit: 3
          attempt_delay: 30000
          with: |
            # Check available parameters in: https://github.com/ReactiveCircus/android-emulator-runner/blob/main/action.yml
            # Available CI host machines: https://docs.github.com/en/actions/reference/runners/github-hosted-runners#standard-github-hosted-runners-for-public-repositories
            # Max api level for 32bit is: 30
            api-level: ${{ inputs.android_api_device }}
            cmake: 4.0.2
            target: google_apis
            arch: ${{ env.android_emulator_arch }}
            disable-animations: true
            disable-spellchecker: true
            channel: stable
            emulator-options: -no-metrics -no-window -accel on -cores ${{ env.ANDROID_EMULATOR_CPU_CORES }} -memory ${{ env.ANDROID_EMULATOR_MEM_MB }} -cache-size 512 -partition-size ${{ env.ANDROID_EMULATOR_MEM_MB }} -ranchu -fixed-scale -skip-adb-auth -gpu swiftshader_indirect -no-audio -no-boot-anim -camera-back none -camera-front none -netfast -no-sim -no-passive-gps -no-direct-adb -no-location-ui -no-hidpi-scaling -no-mouse-reposition -no-nested-warnings -verbose -no-snapshot-save
            cores: ${{ env.ANDROID_EMULATOR_CPU_CORES }}
            ram-size: ${{ env.ANDROID_EMULATOR_MEM_MB }}M
            heap-size: 1024M
            disk-size: 4096M
            sdcard-path-or-size: 2048M
            avd-name: Android_Emulator_API_${{ inputs.android_api_device }}
            force-avd-creation: false
            disable-linux-hw-accel: auto
            enable-hw-keyboard: false
            emulator-boot-timeout: 400 # It can take more than 5 min to boot, and the tests can take more than 17 min to finish.
            script: |
              echo "${{ secrets.ANDROID_SIGNING_KEY_BASE64 }}" | base64 -d > app/MobileRT.jks;
              sh scripts/run_tests_android.sh -t ${{ inputs.type }} -r all -a ${{ inputs.android_api }} -k false -f ${{ env.android_arch }};
              echo "Run Android tests finished: ${?}";

      - name: Print error logs
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: failure()
        run: |
          ls -lahp .;
          set +e;
          echo 'Print JVM errors if provided by Kernel, and just check the logs from the last line of the previous call:';
          sudo dmesg -T;
          echo 'Print native JVM stacktrace if possible:';
          cat hs_err_pid*.log;
          set -e;

      - name: Upload problems reports as artifact
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          # Check available parameters in: https://github.com/actions/upload-artifact/blob/main/action.yml
          name: problems-report
          path: |
            build/reports
            app/build/reports
          if-no-files-found: error
          retention-days: 90
          overwrite: true
          include-hidden-files: true

      - name: Publish Android Test Report
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: ${{ !cancelled() }} # Always run even if the previous step fails
        uses: mikepenz/action-junit-report@3585e9575db828022551b4231f165eb59a0e74e3 # v5
        with:
          # Check available parameters in: https://github.com/mikepenz/action-junit-report/blob/main/action.yml
          report_paths: '**/build/**/androidTest-results/**/TEST-*.xml'
          annotate_only: false
          check_annotations: true
          update_check: false # Possible bug: https://github.com/mikepenz/action-junit-report/issues/927
          check_name: 'Android Test Report - API ${{ inputs.android_api }} d${{ inputs.android_api_device }} ${{ inputs.type }} (${{ inputs.host_os }})'
          fail_on_failure: true
          fail_on_parse_error: true
          require_tests: true
          require_passed_tests: true
          include_passed: true
          check_retries: true
          job_summary: true
          detailed_summary: true
          flaky_summary: true
          verbose_summary: true
          skip_success_summary: false
          include_empty_in_summary: true
          include_time_in_summary: true
          simplified_summary: false
          comment: false
          updateComment: true
          annotate_notice: true
          follow_symlink: true
          skip_annotations: false
          truncate_stack_traces: false
          resolve_ignore_classname: false
          skip_comment_without_tests: false

      - name: Upload Android Test results to Codecov
        if: ${{ !cancelled() }} # Always run even if the previous step fails
        uses: codecov/test-results-action@0fa95f0e1eeaafde2c782583b36b28ad0d8c77d3 # v1
        with:
          # Check available parameters in: https://github.com/codecov/test-results-action/blob/main/action.yml
          token: ${{ secrets.CODECOV_TOKEN }}
          codecov_yml_path: codecov.yml
          directory: app/build/outputs/androidTest-results
          disable_search: false
          fail_ci_if_error: true
          flags: Android-Instrumentation-Tests
          name: Android-instrumentation-test-results
          verbose: true
          version: latest
          working-directory: .

      - name: Check report's paths
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success() && inputs.type == 'debug'
        run: |
          # shellcheck disable=SC1091
          . scripts/helper_functions.sh && checkPathExists app/build/reports/jacoco/jacocoTestReport jacocoTestReport.xml;

      - name: Upload reports to cache
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success() && inputs.type == 'debug'
        uses: actions/cache/save@v5
        with:
          # Check available parameters in: https://github.com/actions/cache/blob/main/save/action.yml
          key: reports_${{ github.sha }}_${{ github.run_id }}_${{ github.run_number }}_a${{ inputs.android_api }}_d${{ inputs.android_api_device }}_${{ inputs.type }}_${{ inputs.host_os }}
          upload-chunk-size: 536870912
          enableCrossOsArchive: false
          path: |
            app/build/reports

      - name: Sign APK
        id: sign-apk
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        uses: ilharp/sign-android-release@13dd52242698526f951aa8bb8696204f6fea702a # v2
        with:
          # Check available parameters in: https://github.com/ilharp/sign-android-release/blob/master/action.yml
          releaseDir: app/build/outputs/apk/${{ inputs.type }}
          signingKey: ${{ secrets.ANDROID_SIGNING_KEY_BASE64 }}
          keyAlias: ${{ secrets.ANDROID_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Upload APK as artifact
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success() && inputs.type == 'release'
        uses: actions/upload-artifact@v6
        with:
          # Check available parameters in: https://github.com/actions/upload-artifact/blob/main/action.yml
          name: MobileRT_${{ inputs.type }}_min_android_api-${{ inputs.android_api }}-apk
          path: ${{ steps.sign-apk.outputs.signedFile }}
          if-no-files-found: error
          retention-days: 90
          overwrite: true
          include-hidden-files: true

      - name: Upload test screenshots as artifact
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        uses: actions/upload-artifact@v6
        with:
          # Check available parameters in: https://github.com/actions/upload-artifact/blob/main/action.yml
          name: MobileRT_${{ inputs.type }}_android_api-a${{ inputs.android_api }}_d${{ inputs.android_api_device }}_test_screenshots
          path: screenshots
          if-no-files-found: warn
          retention-days: 90
          overwrite: true
          include-hidden-files: true


  UnitTests:
    needs: [Build]
    runs-on: ${{ inputs.host_os }}
    timeout-minutes: 360
    name: Unit tests ${{ inputs.android_api }} ${{ inputs.type }} (${{ inputs.host_os }})

    # Sets permissions of the GITHUB_TOKEN to allow publish test results
    permissions:
      checks: write
      pull-requests: write # only required if `comment: true` was enabled

    steps:
      - name: Checkout
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success()
        uses: actions/checkout@v6
        with:
          # Check available parameters in: https://github.com/actions/checkout/blob/main/action.yml
          lfs: true

      - name: Add custom environment variables
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_LONG) }}
        if: success()
        run: |
          echo 'Available Android versions:';
          du -h -d 1 ${ANDROID_HOME}/ndk;
          du -h -d 1 ${ANDROID_HOME}/cmake || true;
          du -h -d 1 ${ANDROID_HOME}/build-tools;
          du -h -d 1 ${ANDROID_HOME}/platforms;
          du -h -d 1 ${ANDROID_HOME}/extras;
          du -h -d 1 ${ANDROID_HOME};
          du -h -d 1 ${HOME};
          echo "GRADLE_PATH=${HOME}/.gradle" >> "${GITHUB_ENV}";

      # Useful step to avoid gradle having to download Gradle dependencies
      # Taken from: https://github.com/marketplace/actions/download-workflow-artifact
      - name: Download Gradle packages artifact
        id: download-gradle-artifact
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success() && !startsWith(inputs.host_os, 'windows')
        uses: Wandalen/wretry.action@e68c23e6309f2871ca8ae4763e7629b9c258e1ea # v3
        with:
          # Check available parameters in: https://github.com/Wandalen/wretry.action/blob/master/action.yml
          action: dawidd6/action-download-artifact@0bd50d53a6d7fb5cb921e607957e9cc12b4ce392 # v12
          pre_retry_command: 'echo "Retrying Download Gradle packages artifact step..."'
          attempt_limit: 3
          attempt_delay: 30000
          with: |
            # Check available parameters in: https://github.com/dawidd6/action-download-artifact/blob/master/action.yml
            # Optional, GitHub token, a Personal Access Token with `public_repo` scope if needed
            # Required, if the artifact is from a different repo
            # Required, if the repo is private a Personal Access Token with `repo` scope is needed
            github_token: ${{ secrets.GITHUB_TOKEN }}
            # Optional, workflow file name or ID
            # If not specified, will be inferred from run_id (if run_id is specified), or will be the current workflow
            workflow: android.yml
            # Optional, the status or conclusion of a completed workflow to search for
            # Can be one of a workflow conclusion:
            #   "failure", "success", "neutral", "cancelled", "skipped", "timed_out", "action_required"
            # Or a workflow status:
            #   "completed", "in_progress", "queued"
            workflow_conclusion: ''
            # Optional, will get head commit SHA
            pr: ${{ github.event.pull_request.number }}
            # Optional, no need to specify if PR is
            commit: ${{ github.event.pull_request.head.sha }}
            # Optional, will use the branch
            # branch: master
            # Optional, defaults to all types
            # event: push
            # Optional, will use specified workflow run
            # run_id: 1122334455
            # Optional, run number from the workflow
            # run_number: 34
            # Optional, uploaded artifact name,
            # will download all artifacts if not specified
            # and extract them into respective subdirectories
            # https://github.com/actions/download-artifact#download-all-artifacts
            name: gradle-packages
            # Optional, a directory where to extract artifact(s), defaults to the current directory
            path: ${{ env.GRADLE_PATH }}
            # Optional, defaults to current repo
            repo: ${{ github.repository }}
            allow_forks: true
            # Optional, check the workflow run to whether it has an artifact
            # then will get the last available artifact from the previous workflow
            # default false, just try to download from the last one
            check_artifacts:  true
            # Optional, search for the last workflow run whose stored an artifact named as in `name` input
            # default false
            search_artifacts: true
            # Optional, choose to skip unpacking the downloaded artifact(s)
            # default false
            skip_unpack: true
            # Optional, choose how to exit the action if no artifact is found
            # can be one of:
            #  "fail", "warn", "ignore"
            # default fail
            if_no_artifact_found: fail

      - name: Extract and check files from gradle artifact
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success() && !startsWith(inputs.host_os, 'windows')
        run: |
          ls -lahp ${{ env.GRADLE_PATH }}/gradle-packages.zip;
          # shellcheck disable=SC1091
          . scripts/helper_functions.sh && extractFilesFromArtifact ${{ env.GRADLE_PATH }};

      - name: Set up JDK
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success()
        uses: actions/setup-java@v5
        with:
          # Check available parameters in: https://github.com/actions/setup-java/blob/main/action.yml
          java-version: 21
          distribution: zulu
          java-package: jdk
          check-latest: false
          server-id: github
          server-username: GITHUB_ACTOR
          server-password: GITHUB_TOKEN
          settings-path: ~/.gradle
          overwrite-settings: true
          gpg-private-key: ''
          gpg-passphrase: GPG_PASSPHRASE
          cache-dependency-path: '**/build.gradle'

      - name: Download generated binaries from cache
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success()
        uses: actions/cache/restore@v5
        with:
          # Check available parameters in: https://github.com/actions/cache/blob/main/restore/action.yml
          key: compiled_${{ github.sha }}_${{ github.run_id }}_${{ github.run_number }}_a${{ inputs.android_api }}_d${{ inputs.android_api_device }}_${{ inputs.type }}_${{ inputs.host_os }}
          restore-keys: compiled_${{ github.sha }}_${{ github.run_id }}_${{ github.run_number }}_a${{ inputs.android_api }}_d${{ inputs.android_api_device }}_${{ inputs.type }}_${{ inputs.host_os }}
          enableCrossOsArchive: false
          fail-on-cache-miss: true
          lookup-only: false
          path: |
            app/build
            app/.cxx
            app/third_party

      - name: Check binaries' paths
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        run: |
          find app/build/ -iname "*.class";
          # shellcheck disable=SC1091
          . scripts/helper_functions.sh && checkPathExists app/build;
          . scripts/helper_functions.sh && checkPathExists app/build/intermediates;
          . scripts/helper_functions.sh && checkPathExists app/build/intermediates/javac;
          . scripts/helper_functions.sh && checkPathExists app/build/intermediates/javac/debug;
          . scripts/helper_functions.sh && checkPathExists app/.cxx;
          . scripts/helper_functions.sh && checkPathExists app/third_party;
          . scripts/helper_functions.sh && checkPathExists ${{ env.GRADLE_PATH }};
          if [ "${{ inputs.android_api }}" -gt 15 ]; then
            typeWithCapitalLetter=$(. scripts/helper_functions.sh && capitalizeFirstletter ${{ inputs.type }});
            . scripts/helper_functions.sh && checkPathExists app/build/intermediates/javac/${{ inputs.type }}/compile${typeWithCapitalLetter}JavaWithJavac/classes;
            # . scripts/helper_functions.sh && checkPathExists app/build/intermediates/built_in_kotlinc/${{ inputs.type }}/compile${typeWithCapitalLetter}Kotlin/classes;
          else
            . scripts/helper_functions.sh && checkPathExists app/build/tmp/kotlin-classes/debug;
          fi

      - name: Set Android CPU Architecture
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        run: |
          set +eu;
          MAJOR_MAC_VERSION=$(sw_vers | grep ProductVersion | cut -d ':' -f2 | cut -d '.' -f1 | tr -d '[:space:]');
          if [ "${MAJOR_MAC_VERSION}" != '' ]; then
            echo "MacOS '${MAJOR_MAC_VERSION}' detected";
          fi
          set -e;
          if ${{ endsWith(inputs.host_os, '-arm') }} = true || "${MAJOR_MAC_VERSION}" -gt 13; then
              echo 'android_arch=\"arm64-v8a\"' >> "${GITHUB_ENV}";
          else
            if [ "${{ inputs.android_api }}" -gt 20 ]; then
              echo 'android_arch=\"x86_64\"' >> "${GITHUB_ENV}";
            else
              echo 'android_arch=\"x86\"' >> "${GITHUB_ENV}";
            fi
          fi
          set -u;

      - name: Download Android dependencies
        timeout-minutes: 8
        if: success()
        run: |
          . scripts/helper_functions.sh && callCommandUntilSuccess 2 timeout 180 sh gradlew test"${{ inputs.type }}"UnitTest lint --dry-run -Dorg.gradle.configuration-cache=false --parallel \
            -DtestType="${{ inputs.type }}" -DandroidApiVersion="${{ inputs.android_api }}" -DabiFilters="[${{ env.android_arch }}]" \
            --info --warning-mode all --stacktrace;

      - name: Run unit tests Java
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success()
        run: |
          echo "android_arch: ${{ env.android_arch }}";
          sh scripts/run_tests.sh -t ${{ inputs.type }} -a ${{ inputs.android_api }} -f ${{ env.android_arch }};

      - name: Print error logs
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: failure()
        run: |
          ls -lahp .;
          set +e;
          echo 'Print JVM errors if provided by Kernel, and just check the logs from the last line of the previous call:';
          sudo dmesg -T;
          echo 'Print native JVM stacktrace if possible:';
          cat hs_err_pid*.log;
          set -e;

      - name: Upload problems reports as artifact
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          # Check available parameters in: https://github.com/actions/upload-artifact/blob/main/action.yml
          name: problems-report
          path: |
            build/reports
            app/build/reports
          if-no-files-found: error
          retention-days: 90
          overwrite: true
          include-hidden-files: true

      - name: Run linter
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success()
        run: |
          sh scripts/check_android.sh -a ${{ inputs.android_api }} -f ${{ env.android_arch }};

      - name: Publish Unit Test Report
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: ${{ !cancelled() }} # Always run even if the previous step fails
        uses: mikepenz/action-junit-report@3585e9575db828022551b4231f165eb59a0e74e3 # v5
        with:
          # Check available parameters in: https://github.com/mikepenz/action-junit-report/blob/main/action.yml
          report_paths: '**/build/**/test-results/**/TEST-*.xml'
          annotate_only: false
          check_annotations: true
          update_check: false # Possible bug: https://github.com/mikepenz/action-junit-report/issues/927
          check_name: 'Unit Test Report - API ${{ inputs.android_api }} ${{ inputs.type }} (${{ inputs.host_os }})'
          fail_on_failure: true
          fail_on_parse_error: true
          require_tests: true
          require_passed_tests: true
          include_passed: true
          check_retries: true
          job_summary: true
          detailed_summary: true
          flaky_summary: true
          verbose_summary: true
          skip_success_summary: false
          include_empty_in_summary: true
          include_time_in_summary: true
          simplified_summary: false
          comment: false
          updateComment: true
          annotate_notice: true
          follow_symlink: true
          skip_annotations: false
          truncate_stack_traces: false
          resolve_ignore_classname: false
          skip_comment_without_tests: false

      - name: Upload Unit Test results to Codecov
        if: ${{ !cancelled() }} # Always run even if the previous step fails
        uses: codecov/test-results-action@0fa95f0e1eeaafde2c782583b36b28ad0d8c77d3 # v1
        with:
          # Check available parameters in: https://github.com/codecov/test-results-action/blob/main/action.yml
          token: ${{ secrets.CODECOV_TOKEN }}
          codecov_yml_path: codecov.yml
          directory: app/build/test-results
          disable_search: false
          fail_ci_if_error: true
          flags: Android-Unit-Tests
          name: Android-unit-test-results
          verbose: true
          version: latest
          working-directory: .

  Sonar:
    needs: [AndroidTests]
    if: inputs.type == 'debug'
    name: Code Coverage & Sonar ${{ inputs.type }} (${{ inputs.host_os }})
    runs-on: ${{ inputs.host_os }}
    timeout-minutes: 360
    steps:
      - name: Checkout
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success()
        uses: actions/checkout@v6
        with:
          # Check available parameters in: https://github.com/actions/checkout/blob/main/action.yml
          lfs: true

      - name: Add custom environment variables
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_LONG) }}
        if: success()
        run: |
          echo 'Available Android versions:';
          du -h -d 1 ${ANDROID_HOME}/ndk;
          du -h -d 1 ${ANDROID_HOME}/cmake || true;
          du -h -d 1 ${ANDROID_HOME}/build-tools;
          du -h -d 1 ${ANDROID_HOME}/platforms;
          du -h -d 1 ${ANDROID_HOME}/extras;
          du -h -d 1 ${ANDROID_HOME};
          du -h -d 1 ${HOME};
          echo "GRADLE_PATH=${HOME}/.gradle" >> "${GITHUB_ENV}";

      # Useful step to avoid gradle having to download Gradle dependencies
      # Taken from: https://github.com/marketplace/actions/download-workflow-artifact
      - name: Download Gradle packages artifact
        id: download-gradle-artifact
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success() && !startsWith(inputs.host_os, 'windows')
        uses: Wandalen/wretry.action@e68c23e6309f2871ca8ae4763e7629b9c258e1ea # v3
        with:
          # Check available parameters in: https://github.com/Wandalen/wretry.action/blob/master/action.yml
          action: dawidd6/action-download-artifact@0bd50d53a6d7fb5cb921e607957e9cc12b4ce392 # v12
          pre_retry_command: 'echo "Retrying Download Gradle packages artifact step..."'
          attempt_limit: 3
          attempt_delay: 30000
          with: |
            # Check available parameters in: https://github.com/dawidd6/action-download-artifact/blob/master/action.yml
            # Optional, GitHub token, a Personal Access Token with `public_repo` scope if needed
            # Required, if the artifact is from a different repo
            # Required, if the repo is private a Personal Access Token with `repo` scope is needed
            github_token: ${{ secrets.GITHUB_TOKEN }}
            # Optional, workflow file name or ID
            # If not specified, will be inferred from run_id (if run_id is specified), or will be the current workflow
            workflow: android.yml
            # Optional, the status or conclusion of a completed workflow to search for
            # Can be one of a workflow conclusion:
            #   "failure", "success", "neutral", "cancelled", "skipped", "timed_out", "action_required"
            # Or a workflow status:
            #   "completed", "in_progress", "queued"
            workflow_conclusion: ''
            # Optional, will get head commit SHA
            pr: ${{ github.event.pull_request.number }}
            # Optional, no need to specify if PR is
            commit: ${{ github.event.pull_request.head.sha }}
            # Optional, will use the branch
            # branch: master
            # Optional, defaults to all types
            # event: push
            # Optional, will use specified workflow run
            # run_id: 1122334455
            # Optional, run number from the workflow
            # run_number: 34
            # Optional, uploaded artifact name,
            # will download all artifacts if not specified
            # and extract them into respective subdirectories
            # https://github.com/actions/download-artifact#download-all-artifacts
            name: gradle-packages
            # Optional, a directory where to extract artifact(s), defaults to the current directory
            path: ${{ env.GRADLE_PATH }}
            # Optional, defaults to current repo
            repo: ${{ github.repository }}
            allow_forks: true
            # Optional, check the workflow run to whether it has an artifact
            # then will get the last available artifact from the previous workflow
            # default false, just try to download from the last one
            check_artifacts:  true
            # Optional, search for the last workflow run whose stored an artifact named as in `name` input
            # default false
            search_artifacts: true
            # Optional, choose to skip unpacking the downloaded artifact(s)
            # default false
            skip_unpack: true
            # Optional, choose how to exit the action if no artifact is found
            # can be one of:
            #  "fail", "warn", "ignore"
            # default fail
            if_no_artifact_found: fail

      - name: Extract and check files from gradle artifact
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success() && !startsWith(inputs.host_os, 'windows')
        run: |
          ls -lahp ${{ env.GRADLE_PATH }}/gradle-packages.zip;
          # shellcheck disable=SC1091
          . scripts/helper_functions.sh && extractFilesFromArtifact ${{ env.GRADLE_PATH }};

      - name: Unshallow repository
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        run: |
          git fetch --unshallow;

      - name: Set up JDK
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success()
        uses: actions/setup-java@v5
        with:
          # Check available parameters in: https://github.com/actions/setup-java/blob/main/action.yml
          # Sonar recommended JVM: https://docs.sonarsource.com/sonarqube-server/analyzing-source-code/languages/java
          java-version: 21
          distribution: zulu
          java-package: jdk
          check-latest: false
          server-id: github
          server-username: GITHUB_ACTOR
          server-password: GITHUB_TOKEN
          settings-path: ~/.gradle
          overwrite-settings: true
          gpg-private-key: ''
          gpg-passphrase: GPG_PASSPHRASE
          cache-dependency-path: '**/build.gradle'

      - name: Download generated binaries from cache
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_MEDIUM) }}
        if: success()
        uses: actions/cache/restore@v5
        with:
          # Check available parameters in: https://github.com/actions/cache/blob/main/restore/action.yml
          key: compiled_${{ github.sha }}_${{ github.run_id }}_${{ github.run_number }}_a${{ inputs.android_api }}_d${{ inputs.android_api_device }}_${{ inputs.type }}_${{ inputs.host_os }}
          restore-keys: compiled_${{ github.sha }}_${{ github.run_id }}_${{ github.run_number }}_a${{ inputs.android_api }}_d${{ inputs.android_api_device }}_${{ inputs.type }}_${{ inputs.host_os }}
          enableCrossOsArchive: false
          fail-on-cache-miss: true
          lookup-only: false
          path: |
            app/build
            app/.cxx
            app/third_party

      - name: Check binaries' paths
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        run: |
          find app/build/ -iname "*.class";
          # shellcheck disable=SC1091
          . scripts/helper_functions.sh && checkPathExists app/build;
          . scripts/helper_functions.sh && checkPathExists app/build/intermediates;
          . scripts/helper_functions.sh && checkPathExists app/build/intermediates/javac;
          . scripts/helper_functions.sh && checkPathExists app/build/intermediates/javac/debug;
          . scripts/helper_functions.sh && checkPathExists app/build/intermediates/javac/debugUnitTest;
          . scripts/helper_functions.sh && checkPathExists app/build/intermediates/javac/debugAndroidTest;
          . scripts/helper_functions.sh && checkPathExists app/.cxx;
          . scripts/helper_functions.sh && checkPathExists app/third_party;
          . scripts/helper_functions.sh && checkPathExists ${{ env.GRADLE_PATH }};
          if [ "${{ inputs.android_api }}" -gt 15 ]; then
            typeWithCapitalLetter=$(. scripts/helper_functions.sh && capitalizeFirstletter ${{ inputs.type }});
            . scripts/helper_functions.sh && checkPathExists app/build/intermediates/javac/${{ inputs.type }}/compile${typeWithCapitalLetter}JavaWithJavac/classes;
            # . scripts/helper_functions.sh && checkPathExists app/build/intermediates/built_in_kotlinc/${{ inputs.type }}/compile${typeWithCapitalLetter}Kotlin/classes;
          else
            . scripts/helper_functions.sh && checkPathExists app/build/tmp/kotlin-classes/debug;
          fi

      - name: Create report's folders
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        run: |
          mkdir -p app/build/reports;

      - name: Download reports from cache
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        uses: actions/cache/restore@v5
        with:
          # Check available parameters in: https://github.com/actions/cache/blob/main/restore/action.yml
          key: reports_${{ github.sha }}_${{ github.run_id }}_${{ github.run_number }}_a${{ inputs.android_api }}_d${{ inputs.android_api_device }}_${{ inputs.type }}_${{ inputs.host_os }}
          restore-keys: reports_${{ github.sha }}_${{ github.run_id }}_${{ github.run_number }}_a${{ inputs.android_api }}_d${{ inputs.android_api_device }}_${{ inputs.type }}_${{ inputs.host_os }}
          enableCrossOsArchive: false
          fail-on-cache-miss: true
          lookup-only: false
          path: |
            app/build/reports

      - name: Check files from reports cache
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        run: |
          # shellcheck disable=SC1091
          . scripts/helper_functions.sh && checkPathExists app/build/reports/jacoco/jacocoTestReport jacocoTestReport.xml;

      - name: Set Android CPU Architecture
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        run: |
          set +eu;
          MAJOR_MAC_VERSION=$(sw_vers | grep ProductVersion | cut -d ':' -f2 | cut -d '.' -f1 | tr -d '[:space:]');
          if [ "${MAJOR_MAC_VERSION}" != '' ]; then
            echo "MacOS '${MAJOR_MAC_VERSION}' detected";
          fi
          set -e;
          if ${{ endsWith(inputs.host_os, '-arm') }} = true || "${MAJOR_MAC_VERSION}" -gt 13; then
              echo 'android_arch=\"arm64-v8a\"' >> "${GITHUB_ENV}";
          else
            if [ "${{ inputs.android_api }}" -gt 20 ]; then
              echo 'android_arch=\"x86_64\"' >> "${GITHUB_ENV}";
            else
              echo 'android_arch=\"x86\"' >> "${GITHUB_ENV}";
            fi
          fi
          set -u;

      - name: Download Android dependencies
        timeout-minutes: 8
        if: success()
        run: |
          . scripts/helper_functions.sh && callCommandUntilSuccess 2 timeout 180 sh gradlew --dry-run -Dorg.gradle.configuration-cache=true --parallel --profile \
            -DabiFilters="[ ${{ env.android_arch }} ]" \
            --info --warning-mode all --stacktrace sonar;

      - name: Analyze Sonar
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          # Available CI host machines: https://docs.github.com/en/actions/reference/runners/github-hosted-runners#standard-github-hosted-runners-for-public-repositories
          # Sonar recommended JVM: https://docs.sonarsource.com/sonarqube-server/analyzing-source-code/languages/java
          GRADLE_OPTS: -Xms8G -Xmx8G -XX:ActiveProcessorCount=5
        run: |
          . scripts/helper_functions.sh && callCommandUntilSuccess 2 timeout 180 sh gradlew --offline --profile --parallel \
            -DabiFilters="[ ${{ env.android_arch }} ]" \
            --info --warning-mode all --stacktrace sonar;

      - name: Print error logs
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: failure()
        run: |
          ls -lahp .;
          set +e;
          echo 'Print JVM errors if provided by Kernel, and just check the logs from the last line of the previous call:';
          sudo dmesg -T;
          echo 'Print native JVM stacktrace if possible:';
          cat hs_err_pid*.log;
          set -e;

      - name: Upload problems reports as artifact
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          # Check available parameters in: https://github.com/actions/upload-artifact/blob/main/action.yml
          name: problems-report
          path: |
            build/reports
            app/build/reports
          if-no-files-found: error
          retention-days: 90
          overwrite: true
          include-hidden-files: true

      - name: Check sonar path
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        run: |
          # shellcheck disable=SC1091
          . scripts/helper_functions.sh && checkPathExists ~/.sonar;

      - name: Send codecov report
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        run: |
          curl --fail-with-body -S --retry 5 --retry-delay 2 --connect-timeout 2 -s https://codecov.io/bash | bash -s -- -v -Z -c -f app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml;

      - name: Upload reports as artifact
        timeout-minutes: ${{ fromJSON(env.GITHUB_STEP_TIMEOUT_SMALL) }}
        if: success()
        uses: actions/upload-artifact@v6
        with:
          # Check available parameters in: https://github.com/actions/upload-artifact/blob/main/action.yml
          name: reports_${{ inputs.android_api }}_d${{ inputs.android_api_device }}_${{ inputs.type }}_${{ inputs.host_os }}
          path: app/build/reports
          if-no-files-found: error
          retention-days: 90
          overwrite: true
          include-hidden-files: true
