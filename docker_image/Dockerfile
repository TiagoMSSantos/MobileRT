###############################################################################
# Set dependency docker image
###############################################################################
ARG BASE_IMAGE=ubuntu:20.04
FROM ${BASE_IMAGE}
###############################################################################
###############################################################################


###############################################################################
# Change user to root
###############################################################################
USER root
###############################################################################
###############################################################################


###############################################################################
# Set apt-get as non interactive mode
###############################################################################
ENV DEBIAN_FRONTEND=noninteractive
###############################################################################
###############################################################################


###############################################################################
# Install dependencies
###############################################################################
RUN \
# if Linux distribution is Debian based \
if [ -x "$(command -v apt-get)" ]; then \
  apt-get update -y; \
  apt-get install --no-install-recommends -y \
    vim \
    findutils \
    cmake \
    make \
    bash \
    ca-certificates \
    git \
    libatomic1 \
    libomp-8-dev \
    qt5-default \
    build-essential; \
# if Linux distribution is Red Hat based \
elif [ -x "$(command -v yum)" ]; then \
  yum update -y; \
  yum install -y \
    vim \
    findutils \
    cmake \
    make \
    bash \
    ca-certificates \
    git \
    which \
    qt5-qtbase-devel \
    gcc-c++; \
# if Linux distribution is Arch Linux based \
elif [ -x "$(command -v pacman)" ]; then \
  pacman -Sy --noconfirm; \
  pacman -S --noconfirm \
    vim \
    findutils \
    cmake \
    make \
    bash \
    ca-certificates \
    git \
    which \
    qt5-base \
    gcc; \
# if Linux distribution is Alpine based \
elif [ -x "$(command -v apk)" ]; then \
  apk update; \
  apk add \
    vim \
    findutils \
    cmake \
    make \
    bash \
    ca-certificates \
    git \
    qt5-qtbase-dev \
    which \
    g++ \
    gcc; \
fi
###############################################################################
###############################################################################


###############################################################################
# Get MobileRT contents (required to create docker image in CI)
###############################################################################
RUN git clone https://github.com/TiagoMSSantos/MobileRT.git
###############################################################################
###############################################################################


###############################################################################
# Setup arguments
###############################################################################
ARG build_type=Release
###############################################################################
###############################################################################


###############################################################################
# Prepare environment (to allow execution of Qt in docker)
###############################################################################
ENV DISPLAY=":1" \
    QT_GRAPHICSSYSTEM="native" \
    LD_LIBRARY_PATH="/MobileRT/libraries:/MobileRT/build_${build_type}/lib" \
    BUILD_TYPE="${build_type}"
###############################################################################
###############################################################################


###############################################################################
# Compile MobileRT
###############################################################################
RUN cd MobileRT && \
    mkdir -p build_${build_type} && \
    cd build_${build_type} && \
    pwd && \
    cmake \
      -DCMAKE_VERBOSE_MAKEFILE=ON \
      -DCMAKE_CXX_COMPILER=g++ \
      -DCMAKE_BUILD_TYPE=${build_type} \
      ../app/ && \
    make && \
    find ./*/* -not -path bin -not -path lib ! -name AppMobileRT ! -name *.so -delete && \
    rm -rf ../app/ && \
    rm -rf ../docs/ && \
    rm -rf ../documentation/ && \
    rm -rf ../git-hooks/ && \
    rm -rf ../gradle/
###############################################################################
###############################################################################


###############################################################################
# Create volume (for Qt)
###############################################################################
VOLUME /tmp/.X11-unix
###############################################################################
###############################################################################


###############################################################################
# Execute MobileRT
###############################################################################
WORKDIR /MobileRT/build_${build_type}
CMD bash ../scripts/profile.sh ${BUILD_TYPE}
###############################################################################
###############################################################################
