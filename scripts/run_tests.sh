#!/bin/bash

###############################################################################
# Exit immediately if a command exits with a non-zero status
###############################################################################
set -e
###############################################################################
###############################################################################

###############################################################################
# Change directory to MobileRT root
###############################################################################
cd "$(dirname "${BASH_SOURCE[0]}")/.." || exit
###############################################################################
###############################################################################

###############################################################################
# Get arguments
###############################################################################
type="${1:-release}"
ndk_version="${2:-21.3.6528147}"
cmake_version="${3:-3.10.2}"
###############################################################################
###############################################################################

###############################################################################
# Get helper functions
###############################################################################
source scripts/helper_functions.sh
###############################################################################
###############################################################################

###############################################################################
# Run unit tests natively
###############################################################################

# Set path to reports
reports_path=./app/build/reports
callCommand mkdir -p ${reports_path}

type=$(capitalizeFirstletter "${type}")
echo "type: '${type}'"

function runUnitTests() {
  echo "Calling Gradle test"
  callCommand ./gradlew --stop
  callCommand ./gradlew test"${type}"UnitTest --profile --parallel \
    -DndkVersion="${ndk_version}" -DcmakeVersion="${cmake_version}" \
    --console plain \
    2>&1 | tee ${reports_path}/log_native_tests_"${type}".log
  resUnitTests=${PIPESTATUS[0]}
}
###############################################################################
###############################################################################

runUnitTests
echo ""
echo -e '\e]8;;file:///'"${PWD}"'/'${reports_path}'/tests/test'"${type}"'UnitTest/index.html\aClick here to check the Unit tests report.\e]8;;\a'
echo ""
echo ""

###############################################################################
# Exit code
###############################################################################
printCommandExitCode "${resUnitTests}" "Unit tests"
###############################################################################
###############################################################################
